<script>
/**
 * ===================================================================
 * SETTINGS PAGE LOGIC
 * ===================================================================
 */

/**
 * Main loader function for the entire settings page.
 * This is called by the core navigation logic when the page is first shown.
 */
function load_settings() {
    // Use a flag to ensure listeners are only attached once.
    if (window.settingsListenersAttached) return;

    // Attach listeners to the main setting tabs.
    document.getElementById('settings-tab-general').addEventListener('click', () => {
        settings_navigateToTab(document.getElementById('settings-tab-general'), 'tab-set-general');
        loadGeneralSettings();
        loadPermissionsMatrix();
    });
    document.getElementById('settings-tab-staff').addEventListener('click', () => {
        settings_navigateToTab(document.getElementById('settings-tab-staff'), 'tab-set-staff');
        loadRoleAssignmentData();
    });
    document.getElementById('settings-tab-scheduling').addEventListener('click', () => {
        settings_navigateToTab(document.getElementById('settings-tab-scheduling'), 'tab-set-scheduling');
        loadSchedulingRosterData();
    });
    document.getElementById('settings-tab-proctoring').addEventListener('click', () => {
        settings_navigateToTab(document.getElementById('settings-tab-proctoring'), 'tab-set-proctoring');
        loadProctoringSettings();
    });
    document.getElementById('settings-tab-reporting').addEventListener('click', () => {
        settings_navigateToTab(document.getElementById('settings-tab-reporting'), 'tab-set-reporting');
        loadReportingSettings();
    });

    window.settingsListenersAttached = true;

    // Initially, load the content for the default tab.
    loadGeneralSettings();
    loadPermissionsMatrix();
}

/**
 * Handles switching between the main tabs on the Settings page.
 * @param {HTMLElement} clickedTab - The tab element that was clicked.
 * @param {string} targetTabId - The ID of the content element to show.
 */
function settings_navigateToTab(clickedTab, targetTabId) {
    const tabContainer = clickedTab.closest('.tab-nav');
    const pageContainer = tabContainer.parentElement;

    tabContainer.querySelectorAll('.tab-nav-item').forEach(item => item.classList.remove('active'));
    clickedTab.classList.add('active');

    pageContainer.querySelectorAll('.tab-page').forEach(content => content.classList.remove('active'));
    document.getElementById(targetTabId).classList.add('active');
}

// ... (rest of the functions: loadGeneralSettings, loadPermissionsMatrix, etc. remain the same)


/**
 * ===================================================================
 * 1. GENERAL & ACCESS PANEL
 * ===================================================================
 */

function loadGeneralSettings() {
    loadAllSettings();
}

function loadPermissionsMatrix() {
    const container = document.getElementById('permissions-matrix-table');
    container.innerHTML = '<p>Loading permissions...</p>';
    google.script.run.withSuccessHandler(res => {
        if (res.error) {
            container.innerHTML = `<p class="status-message error">${res.error}</p>`;
            return;
        }
        const { matrix, roles, pages } = res.data;
        let html = '<table class="permission-table"><thead><tr><th>Page Access</th>';
        roles.forEach(role => { html += `<th>${role}</th>`; });
        html += '</tr></thead><tbody>';

        pages.forEach(page => {
            html += `<tr><td>${page.name}</td>`;
            roles.forEach(role => {
                const isChecked = matrix[page.id] && matrix[page.id][role];
                html += `<td><input type="checkbox" data-page="${page.id}" data-role="${role}" ${isChecked ? 'checked' : ''}></td>`;
            });
            html += '</tr>';
        });

        html += '</tbody></table>';
        container.innerHTML = html;
    }).getAccessControlData();
}

function handleSavePermissions() {
    const matrix = {};
    document.querySelectorAll('#permissions-matrix-table input[type="checkbox"]').forEach(input => {
        const page = input.dataset.page;
        const role = input.dataset.role;
        if (!matrix[page]) {
            matrix[page] = {};
        }
        matrix[page][role] = input.checked;
    });
    
    setStatus('permissions-status', 'Saving...', 'loading');
    google.script.run.withSuccessHandler(res => {
        setStatus('permissions-status', res.message, res.success ? 'success' : 'error');
    }).savePermissionsMatrix(matrix);
}


/**
 * ===================================================================
 * 2. STAFF MANAGEMENT PANEL
 * ===================================================================
 */

function loadRoleAssignmentData() {
    const container = document.getElementById('role-assignment-list');
    container.innerHTML = '<p>Loading staff...</p>';
    google.script.run.withSuccessHandler(res => {
        if (res.error) {
            container.innerHTML = `<p class="status-message error">${res.error}</p>`;
            return;
        }
        let html = '<table class="data-table"><thead><tr><th>Name</th><th>Email / ID</th><th>Role</th><th>Action</th></tr></thead><tbody>';
        res.data.forEach(staff => {
            html += `<tr>
                <td>${staff.name}</td>
                <td>${staff.id}</td>
                <td>
                    <select data-staff-id="${staff.id}" class="role-select">
                        <option value="Staff" ${staff.role === 'Staff' ? 'selected' : ''}>Staff</option>
                        <option value="Lead" ${staff.role === 'Lead' ? 'selected' : ''}>Lead</option>
                        <option value="Admin" ${staff.role === 'Admin' ? 'selected' : ''}>Admin</option>
                    </select>
                </td>
                <td><button class="button danger btn-sm" onclick="handleDeleteStaff('${staff.id}', this)">Remove</button></td>
            </tr>`;
        });
        html += '</tbody></table>';
        container.innerHTML = html;
    }).api_getStaffForRoleAssignment();
}

function handleAddStaff() {
    const name = document.getElementById('new-staff-name').value;
    const id = document.getElementById('new-staff-id').value;
    const role = document.getElementById('new-staff-role').value;

    if (!name || !id) {
        setStatus('add-staff-status', 'Name and ID are required.', 'error');
        return;
    }

    setStatus('add-staff-status', 'Adding...', 'loading');
    google.script.run.withSuccessHandler(res => {
        setStatus('add-staff-status', res.message, res.success ? 'success' : 'error');
        if (res.success) {
            loadRoleAssignmentData();
            document.getElementById('new-staff-name').value = '';
            document.getElementById('new-staff-id').value = '';
        }
    }).api_addNewStaff(name, id, role);
}

function handleSaveRoleAssignments() {
    const assignments = [];
    document.querySelectorAll('.role-select').forEach(select => {
        assignments.push({
            id: select.dataset.staffId,
            role: select.value
        });
    });

    setStatus('role-assignment-status', 'Saving roles...', 'loading');
    google.script.run.withSuccessHandler(res => {
        setStatus('role-assignment-status', res.message, res.success ? 'success' : 'error');
    }).api_saveAllRoleAssignments(assignments);
}

function handleDeleteStaff(staffId, buttonElement) {
    if (confirm(`Are you sure you want to remove this staff member?`)) {
        buttonElement.closest('tr').style.backgroundColor = '#ffdddd';
        setStatus('role-assignment-status', 'Deleting...', 'loading');
        google.script.run.withSuccessHandler(res => {
            setStatus('role-assignment-status', res.message, res.success ? 'success' : 'error');
            if (res.success) {
                loadRoleAssignmentData();
            }
        }).api_deleteStaff(staffId);
    }
}

/**
 * ===================================================================
 * 3. SCHEDULING CONFIG PANEL
 * ===================================================================
 */

function loadSchedulingRosterData() {
    const container = document.getElementById('manage-shifts-list');
    container.innerHTML = '<p>Loading shifts...</p>';
    google.script.run.withSuccessHandler(res => {
        if (res.error) {
            container.innerHTML = `<p class="status-message error">${res.error}</p>`;
            return;
        }
        let html = '<table class="data-table"><thead><tr><th><input type="checkbox" onchange="toggleAllShiftCheckboxes(this)"></th><th>Day</th><th>Time</th><th>Description</th><th>Zoom?</th></tr></thead><tbody>';
        res.data.forEach(shift => {
            html += `<tr>
                <td><input type="checkbox" class="shift-checkbox" value="${shift.id}"></td>
                <td>${shift.day}</td>
                <td>${shift.start} - ${shift.end}</td>
                <td>${shift.desc}</td>
                <td>${shift.zoom ? '✔️' : '✖️'}</td>
            </tr>`;
        });
        html += '</tbody></table>';
        container.innerHTML = html;
    }).api_getShifts(); 
}

function handleAddShift() {
    const days = Array.from(document.querySelectorAll('.shift-day-check:checked')).map(cb => cb.value);
    const shift = {
      desc: document.getElementById('shift-add-desc').value,
      start: document.getElementById('shift-add-start').value,
      end: document.getElementById('shift-add-end').value,
      zoom: document.getElementById('shift-add-zoom').checked
    };

    if (days.length === 0 || !shift.desc || !shift.start || !shift.end) {
        alert('Please select at least one day and fill in all fields.');
        return;
    }

    google.script.run.withSuccessHandler(res => {
        if(res.success) {
            loadSchedulingRosterData(); // Refresh list
        } else {
            alert('Error adding shifts: ' + res.message);
        }
    }).api_addShifts(days, shift);
}

function handleBulkDeleteShifts() {
    const ids = Array.from(document.querySelectorAll('.shift-checkbox:checked')).map(cb => cb.value);
    if(ids.length === 0) return;

    if(confirm(`Are you sure you want to delete ${ids.length} selected shift(s)?`)) {
        google.script.run.withSuccessHandler(res => {
            if(res.success) {
                loadSchedulingRosterData();
            } else {
                alert('Error deleting shifts: ' + res.message);
            }
        }).api_deleteShifts(ids);
    }
}

function handleClearAllShifts() {
    if(confirm('Are you sure you want to delete ALL shifts? This cannot be undone.')) {
        google.script.run.withSuccessHandler(res => {
            if(res.success) {
                loadSchedulingRosterData();
            } else {
                alert('Error clearing shifts: ' + res.message);
            }
        }).api_deleteAllShifts();
    }
}

function toggleAllShiftCheckboxes(master) {
    document.querySelectorAll('.shift-checkbox').forEach(cb => cb.checked = master.checked);
}


/**
 * ===================================================================
 * 4. PROCTORING CONFIG PANEL
 * ===================================================================
 */
function loadProctoringSettings() {
    mlt_loadSettings(); 
    // nursing_loadSettings(); // This would be added for the Nursing side
}

/**
 * ===================================================================
 * 5. REPORTING & DATA PANEL
 * ===================================================================
 */
function loadReportingSettings() {
    google.script.run.withSuccessHandler(calendars => {
        const select = document.getElementById('setting-target-calendar');
        select.innerHTML = '<option value="">Select a calendar</option>';
        calendars.data.forEach(cal => {
            select.innerHTML += `<option value="${cal.id}">${cal.name}</option>`;
        });
    }).getWritableCalendars();

    google.script.run.withSuccessHandler(tabs => {
        const select = document.getElementById('setting-source-tab');
        select.innerHTML = '<option value="">Select a tab</option>';
        tabs.forEach(tab => {
            select.innerHTML += `<option value="${tab}">${tab}</option>`;
        });
    }).getSheetNames();

    loadCalendarTemplates();
}

function loadCalendarTemplates() {
     const container = document.getElementById('saved-templates-list');
     container.innerHTML = 'Loading templates...';
     google.script.run.withSuccessHandler(res => {
        container.innerHTML = '';
        if(res.success && res.data) {
            res.data.forEach(t => {
                container.innerHTML += `<div class="template-chip">${t.name}<span onclick="handleDeleteTemplate('${t.id}')">✖️</span></div>`;
            });
        }
     }).getCalendarTemplates();
}

function handleAddTemplate() {
    const name = document.getElementById('template-name-input').value;
    const pattern = document.getElementById('template-pattern-input').value;
    if(!name || !pattern) return;

    google.script.run.withSuccessHandler(res => {
        if(res.success) loadCalendarTemplates();
    }).addCalendarTemplate(name, pattern);
}

function handleDeleteTemplate(id) {
    if(confirm('Delete this template?')) {
        google.script.run.withSuccessHandler(res => {
            if(res.success) loadCalendarTemplates();
        }).deleteCalendarTemplate(id);
    }
}

function loadTabHeaders(tabName) {
    const container = document.getElementById('available-headers-list');
    container.innerHTML = 'Loading headers...';
    google.script.run.withSuccessHandler(headers => {
        container.innerHTML = '';
        headers.forEach(h => {
            container.innerHTML += `<div class="header-chip" onclick="addHeaderToTemplate('${h}')">${h}</div>`;
        });
    }).getSheetHeaders(tabName);
}

function addHeaderToTemplate(header) {
    const input = document.getElementById('template-pattern-input');
    input.value += `{{${header}}}`;
}

function saveCalendarSettings() {
    const settings = {
        calendarId: document.getElementById('setting-manual-calendar-id').value,
        sourceTab: document.getElementById('setting-source-tab').value,
    };
    setStatus('calendarSettings-status', 'Saving...', 'loading');
    google.script.run.withSuccessHandler(res => {
        setStatus('calendarSettings-status', res.message, res.success ? 'success' : 'error');
    }).saveSettings(settingsKey, settings);
}

/**
 * ===================================================================
 * X. GLOBAL SETTINGS SAVER & LOADER
 * ===================================================================
 */

function handleSaveSettings(settingsKey) {
    let settings = {};
    let statusId = `${settingsKey}-status`;

    switch (settingsKey) {
        case 'adminSettings':
            settings = {
                dataHubId: document.getElementById('data-hub-id').value,
                logoFileId: document.getElementById('logo-file-id').value
            };
            break;
        case 'courseImportSettings':
            settings = {
                courseSheetId: document.getElementById('course-sheet-id').value,
                courseTabName: document.getElementById('course-tab-name').value
            };
            break;
        case 'schedulingSettings':
            settings = {
                techHubZoomUrl: document.getElementById('tech-hub-zoom-url').value
            };
            break;
        case 'nursingExamSettings':
             const aliasInputs = document.querySelectorAll('#nursing-header-aliases-container input');
             const aliases = {};
             aliasInputs.forEach(input => { aliases[input.dataset.key] = input.value; });
             settings = {
                nursingSheetId: document.getElementById('nursing-sheet-id').value,
                nursingFolderId: document.getElementById('nursing-folder-id').value,
                nursingHeaderAliases: aliases
             };
             break;
        case 'examSettings':
             settings = {
                examCalendarId: document.getElementById('exam-calendar-id').value,
                proctorCapability: document.getElementById('proctor-capability').value
             };
             break;
        case 'reportingSettings':
            settings = {
                lookerStudioUrl: document.getElementById('reporting-url-input').value
            };
            break;
    }

    setStatus(statusId, 'Saving...', 'loading');
    google.script.run.withSuccessHandler(res => {
        setStatus(statusId, res.message, res.success ? 'success' : 'error');
        if(res.success && settingsKey === 'adminSettings') {
             google.script.run.withSuccessHandler(loadLogo).getSetting('logoFileId');
        }
    }).saveSettings(settingsKey, settings);
}

function loadAllSettings() {
    google.script.run.withSuccessHandler(response => {
        if (!response.success || !response.data) {
            console.error('Failed to load settings:', response.message);
            return;
        }

        const allSettings = response.data;

        // Helper function to safely access nested properties
        const getSetting = (key, property) => {
            return allSettings[key] && allSettings[key][property] ? allSettings[key][property] : '';
        };

        // --- Populate General & Admin Settings ---
        document.getElementById('data-hub-id').value = getSetting('adminSettings', 'dataHubId');
        document.getElementById('logo-file-id').value = getSetting('adminSettings', 'logoFileId');

        // --- Populate Course Import Settings ---
        document.getElementById('course-sheet-id').value = getSetting('courseImportSettings', 'courseSheetId');
        document.getElementById('course-tab-name').value = getSetting('courseImportSettings', 'courseTabName');
        
        // --- Populate Scheduling Settings ---
        document.getElementById('tech-hub-zoom-url').value = getSetting('schedulingSettings', 'techHubZoomUrl');

        // --- Populate Nursing Exam Settings ---
        document.getElementById('nursing-sheet-id').value = getSetting('nursingExamSettings', 'nursingSheetId');
        document.getElementById('nursing-folder-id').value = getSetting('nursingExamSettings', 'nursingFolderId');
        const aliases = allSettings.nursingExamSettings ? allSettings.nursingExamSettings.nursingHeaderAliases : null;
        if (aliases) {
            const container = document.getElementById('nursing-header-aliases-container');
            container.innerHTML = '';
            for (const key in aliases) {
                container.innerHTML += `<div class="form-group inline-group"><label>${key}</label><input type="text" data-key="${key}" value="${aliases[key]}"></div>`;
            }
        }

        // --- Populate General Exam Settings ---
        document.getElementById('exam-calendar-id').value = getSetting('examSettings', 'examCalendarId');
        document.getElementById('proctor-capability').value = getSetting('examSettings', 'proctorCapability');

        // --- Populate Reporting Settings ---
        document.getElementById('reporting-url-input').value = getSetting('reportingSettings', 'lookerStudioUrl');

        // --- Populate Manual Calendar/Tab Settings (Legacy or Specific Use) ---
        const calendarSettings = allSettings.calendarSettings || {};
        document.getElementById('setting-manual-calendar-id').value = calendarSettings.calendarId || '';
        if (calendarSettings.calendarId) document.getElementById('setting-target-calendar').value = calendarSettings.calendarId;
        if (calendarSettings.sourceTab) document.getElementById('setting-source-tab').value = calendarSettings.sourceTab;

        // --- Load the Logo ---
        const logoFileId = getSetting('adminSettings', 'logoFileId');
        if (logoFileId) {
            loadLogo(logoFileId);
        }

    }).api_getAllSettings();
}

function loadLogo(fileId) {
    const logoContainer = document.getElementById('app-logo');
    if (logoContainer && fileId) {
        logoContainer.innerHTML = '<div class="spinner-tiny"></div>';
        google.script.run.withSuccessHandler(dataUrl => {
            if (dataUrl) {
                logoContainer.innerHTML = `<img src="${dataUrl}" alt="App Logo">`;
            }
        }).getImageDataUrl(fileId);
    }
}
</script>
