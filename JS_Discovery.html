<script>
  // --- DISCOVERY VARIABLES ---
  var discovery_scanResults = [];
  var discovery_existingCategories = [];

  function discovery_init() {
    // Load Calendars
    // UPDATED: Uses getAllViewableCalendars to see Shared/Resource calendars
    google.script.run.withSuccessHandler(function(res) {
      const sel = document.getElementById('discovery-calendar-select');
      if (res.success && res.data) {
        sel.innerHTML = '<option value="" disabled selected>Select Calendar...</option>';
        res.data.forEach(c => {
           const opt = document.createElement('option');
           opt.value = c.id;
           opt.text = c.name;
           sel.appendChild(opt);
        });
      }
    }).getAllViewableCalendars();

    // Load Existing Categories for Dropdown
    google.script.run.withSuccessHandler(function(res) {
      if (res.success && res.data) {
        discovery_existingCategories = res.data.map(d => d.name);
      }
    }).api_getEventTypes();
  }

  function discovery_handleScan() {
    const calId = document.getElementById('discovery-calendar-select').value;
    const days = document.getElementById('discovery-days-back').value;
    
    if (!calId) { ui_setStatus('discovery-status', 'Please select a calendar.', 'error'); return; }

    ui_setStatus('discovery-status', 'Scanning events... this may take a moment.', 'loading');
    document.getElementById('discovery-results-area').style.display = 'none';

    google.script.run.withSuccessHandler(function(res) {
      if (res.success) {
        ui_setStatus('discovery-status', `Scan Complete. Analyzed ${res.count} events.`, 'success');
        discovery_scanResults = res.data;
        discovery_renderTable();
        document.getElementById('discovery-results-area').style.display = 'block';
      } else {
        ui_setStatus('discovery-status', res.message, 'error');
      }
    }).api_discovery_scanCalendar(calId, parseInt(days));
  }

  function discovery_renderTable() {
    const container = document.getElementById('discovery-table-container');
    if (discovery_scanResults.length === 0) {
      container.innerHTML = '<p>No frequent patterns found.</p>';
      return;
    }

    let html = '<table class="data-table"><thead><tr><th>Keyword / Pattern</th><th>Frequency</th><th>Assign Category</th></tr></thead><tbody>';
    
    // Build Category Options
    let catOptions = '<option value="">-- Skip --</option>';
    discovery_existingCategories.forEach(c => {
        catOptions += `<option value="${c}">${c}</option>`;
    });
    catOptions += '<option value="NEW">[+ New Category]</option>';

    discovery_scanResults.forEach((item, idx) => {
      html += `<tr>
        <td><strong>${item.keyword}</strong></td>
        <td>${item.count}</td>
        <td>
          <select class="discovery-cat-select" data-keyword="${item.keyword}" onchange="discovery_checkNew(this, ${idx})">
            ${catOptions}
          </select>
          <input type="text" id="discovery-new-cat-${idx}" placeholder="Type new category..." style="display:none; margin-top:5px; width:100%;">
        </td>
      </tr>`;
    });
    html += '</tbody></table>';
    container.innerHTML = html;
  }

  function discovery_checkNew(select, idx) {
    const input = document.getElementById(`discovery-new-cat-${idx}`);
    if (select.value === 'NEW') {
      input.style.display = 'block';
      input.focus();
    } else {
      input.style.display = 'none';
    }
  }

  function discovery_handleSave() {
    const selects = document.querySelectorAll('.discovery-cat-select');
    const rulesToSave = [];

    selects.forEach((sel, idx) => {
      let category = sel.value;
      if (category === 'NEW') {
        category = document.getElementById(`discovery-new-cat-${idx}`).value.trim();
      }
      
      if (category && category !== "") {
        rulesToSave.push({
          keyword: sel.getAttribute('data-keyword'),
          category: category
        });
      }
    });

    if (rulesToSave.length === 0) {
      ui_setStatus('discovery-status', 'No rules selected to save.', 'error');
      return;
    }

    ui_setStatus('discovery-status', `Saving ${rulesToSave.length} rules...`, 'loading');
    
    google.script.run.withSuccessHandler(function(res) {
      if (res.success) {
        ui_setStatus('discovery-status', 'Rules Saved! You can now use these in Reports.', 'success');
        // Refresh categories for next time
        discovery_init();
        // Clear table to prevent double save
        document.getElementById('discovery-table-container').innerHTML = '<p>Saved.</p>';
      } else {
        ui_setStatus('discovery-status', res.message, 'error');
      }
    }).api_discovery_saveRules(rulesToSave);
  }
</script>