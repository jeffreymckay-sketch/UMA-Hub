<script>
  App.api = (function() {
    /**
     * A generic wrapper for google.script.run that returns a Promise.
     * This makes server-side calls feel more like modern JavaScript.
     * @param {string} functionName - The name of the server-side function to call.
     * @param {any[]} args - The arguments to pass to the server-side function.
     * @returns {Promise<any>} A Promise that resolves with the server's response or rejects with an error.
     */
    function serverCall(functionName, ...args) {
      return new Promise((resolve, reject) => {
        google.script.run
          .withSuccessHandler(resolve)
          .withFailureHandler(reject)
          [functionName](...args);
      });
    }

    // --- Public API Functions ---
    return {
      // Core
      getAccessControlData: () => serverCall('api_getAccessControlData'),
      getAllSettings: () => serverCall('api_getAllSettings'),
      saveSettings: (key, data) => serverCall('saveSettings', key, data),
      getSettings: (key) => serverCall('getSettings', key),
      getImageDataUrl: (fileId) => serverCall('api_getImageDataUrl'),
      getDataHubTabs: () => serverCall('api_getDataHubTabs'),
      getTabHeaders: (tabName) => serverCall('api_getTabHeaders'),

      // Scheduling
      scheduling: {
        getViewData: () => serverCall('getMSTViewData'),
        updateAssignment: (courseId, staffId) => serverCall('api_updateCourseAssignment', courseId, staffId),
        addCourse: (details) => serverCall('api_addCourse', details),
        updateCourse: (details) => serverCall('api_updateCourse', details),
        deleteCourse: (id) => serverCall('api_deleteCourse', id),
        export: (assignments) => serverCall('api_exportCourseAssignments', assignments),
      },

      // Calendar
      calendar: {
        getWritableCalendars: () => serverCall('getWritableCalendars'),
        getAllViewableCalendars: () => serverCall('getAllViewableCalendars'),
        getTargetName: () => serverCall('api_getCalendarTargetName'),
        preview: (template, target) => serverCall('api_previewSheetToCalendar', template, target),
        sync: (template, rows, target) => serverCall('api_syncSheetToCalendar', template, rows, target),
        syncStaff: (target) => serverCall('api_syncStaffToCalendar', target),
        getEvents: (start, end, id) => serverCall('api_getCalendarEvents', start, end, id),
        exportEvents: (events) => serverCall('api_exportCalendarEvents', events)
      },

      // Classrooms
      classrooms: {
        getHeaders: (url, tab) => serverCall('api_lookup_getHeaders', url, tab),
        getData: (url, tab) => serverCall('api_lookup_getData', url, tab),
        fetchData: (url, tab) => serverCall('api_fetchSheetData', url, tab),
        bulkUpdate: (url, tab, updates) => serverCall('api_bulkUpdateSheet', url, tab, updates),
        exportToSheet: (headers, rows) => serverCall('exportToSheet', headers, rows),
      },

      // Reports
      reports: {
        getReportData: (start, end, staff) => serverCall('api_getReportData', start, end, staff)
      },

      // Zoom
      zoom: {
        getRecordings: (start, end) => serverCall('api_getZoomRecordings', start, end)
      },

      // Nursing
      nursing: {
        getEmailSettings: () => serverCall('nursing_getEmailSettings'),
      },
    };
  })();
</script>
