<script>
  // --- CALENDAR CONFIG & TEMPLATES ---
  function loadCalendarOptions() {
    google.script.run.withSuccessHandler(function(res) {
      const select = document.getElementById('setting-target-calendar');
      const mstSelect = document.getElementById('mst-sync-calendar-select');
      
      if (res.success && res.data) { 
          if(select) select.innerHTML = '<option value="" disabled selected>Select a Calendar...</option>';
          if(mstSelect) mstSelect.innerHTML = '<option value="" disabled selected>Select a Calendar...</option>';
          
          res.data.forEach(cal => { 
              const option = document.createElement('option'); 
              option.value = cal.id; 
              option.text = cal.name; 
              if(select) select.appendChild(option);
              if(mstSelect) mstSelect.appendChild(option.cloneNode(true));
          }); 
          
          loadCurrentCalendarSettings(); 
      }
    }).getWritableCalendars();
  }
  
  function loadSourceTabOptions() {
    google.script.run.withSuccessHandler(function(res) {
      const select = document.getElementById('setting-source-tab');
      if(!select) return;
      select.innerHTML = '<option value="" disabled selected>Select Source Tab...</option>';
      if (res.success && res.data) { res.data.forEach(tab => { const option = document.createElement('option'); option.value = tab; option.text = tab; select.appendChild(option); }); }
    }).api_getDataHubTabs();
  }
  
  function loadTabHeaders(tabName) {
    const container = document.getElementById('available-headers-list');
    container.innerHTML = 'Loading headers...';
    google.script.run.withSuccessHandler(function(res) {
      if (res.success && res.data) { container.innerHTML = ''; res.data.forEach(h => { const tag = document.createElement('span'); tag.className = 'header-tag'; tag.style.cssText = 'background: #e0e0e0; padding: 2px 6px; border-radius: 4px; cursor: pointer; font-size: 0.85em;'; tag.textContent = h; tag.onclick = function() { const input = document.getElementById('template-pattern-input'); input.value += `{{${h}}}`; }; container.appendChild(tag); }); } else { container.innerHTML = 'Error loading headers.'; }
    }).api_getTabHeaders(tabName);
  }

  function loadCurrentCalendarSettings() {
    google.script.run.withSuccessHandler(function(settings) {
      const calSelect = document.getElementById('setting-target-calendar');
      const manualInput = document.getElementById('setting-manual-calendar-id');
      const sourceSelect = document.getElementById('setting-source-tab');
      const syncTemplateSelect = document.getElementById('sync-template-select');
      const mstSelect = document.getElementById('mst-sync-calendar-select');

      if (settings) {
        if (settings.targetCalendarId) { 
            if (calSelect) calSelect.value = settings.targetCalendarId; 
            if (manualInput) manualInput.value = settings.targetCalendarId; 
            if (mstSelect) mstSelect.value = settings.targetCalendarId; 
            updateConfigStatus(true); 
        } else { updateConfigStatus(false); }
        
        if (settings.sourceTabName && sourceSelect) { sourceSelect.value = settings.sourceTabName; loadTabHeaders(settings.sourceTabName); }
        currentTemplates = settings.savedTemplates || [];
        renderSavedTemplates();
        if (syncTemplateSelect) { syncTemplateSelect.innerHTML = ''; if (currentTemplates.length === 0) { syncTemplateSelect.innerHTML = '<option value="Default">Default (Course - Faculty)</option>'; } else { currentTemplates.forEach(t => { const opt = document.createElement('option'); opt.value = t.name; opt.text = t.name + " (" + t.pattern + ")"; syncTemplateSelect.appendChild(opt); }); } }
      }
    }).getSettings('calendarSettings');
  }
  
  function handleAddTemplate() {
    const name = document.getElementById('template-name-input').value.trim();
    const pattern = document.getElementById('template-pattern-input').value.trim();
    if (!name || !pattern) { ui_setStatus('calendarSettings-status', 'Name and Pattern required.', 'error'); return; }
    currentTemplates.push({ name: name, pattern: pattern });
    document.getElementById('template-name-input').value = '';
    document.getElementById('template-pattern-input').value = '';
    renderSavedTemplates();
  }
  
  function handleDeleteTemplate(index) { currentTemplates.splice(index, 1); renderSavedTemplates(); }
  
  function renderSavedTemplates() {
    const list = document.getElementById('saved-templates-list');
    if (!list) return;
    if (currentTemplates.length === 0) { list.innerHTML = '<p style="color:#666; font-style:italic;">No templates saved.</p>'; return; }
    let html = '<ul style="list-style:none; padding:0;">';
    currentTemplates.forEach((t, i) => { html += `<li style="background:#fff; border:1px solid #ddd; padding:5px; margin-bottom:5px; display:flex; justify-content:space-between; align-items:center;"><span><strong>${t.name}</strong>: ${t.pattern}</span><button class="button danger" style="padding:2px 8px; font-size:0.8em;" onclick="handleDeleteTemplate(${i})">X</button></li>`; });
    html += '</ul>';
    list.innerHTML = html;
  }

  function updateConfigStatus(isConfigured) {
    const el = document.getElementById('calendar-config-status');
    if (!el) return;
    google.script.run.withSuccessHandler(function(res) {
        if (isConfigured) { const calName = res.success ? res.name : "Unknown Calendar"; el.className = "status-message success"; el.innerHTML = `‚úÖ <strong>Ready:</strong> Targeted Calendar: <strong>${calName}</strong>`; } else { el.className = "status-message error"; el.innerHTML = "‚ö†Ô∏è <strong>Not Configured:</strong> Please go to Settings to select a Target Calendar."; }
    }).api_getCalendarTargetName();
  }

  function saveCalendarSettings() {
    const btn = document.querySelector('#settings-calendar button');
    btn.disabled = true;
    ui_setStatus('calendarSettings-status', 'Saving...', 'loading');
    var manualId = document.getElementById('setting-manual-calendar-id').value.trim();
    var dropdownId = document.getElementById('setting-target-calendar').value;
    var finalId = manualId ? manualId : dropdownId;
    if (!finalId) { btn.disabled = false; ui_setStatus('calendarSettings-status', 'Error: No Calendar ID selected or entered.', 'error'); return; }
    const settings = { targetCalendarId: finalId, sourceTabName: document.getElementById('setting-source-tab').value, savedTemplates: currentTemplates };
    google.script.run.withSuccessHandler(function(res) { btn.disabled = false; ui_setStatus('calendarSettings-status', res.message, res.success ? 'success' : 'error'); if(res.success) { updateConfigStatus(true); loadCurrentCalendarSettings(); } }).saveSettings('calendarSettings', settings);
  }

  // --- SYNC & INSPECT ---
  
  var currentSyncPreview = [];
  var currentSyncCalendarId = null; 

  function handleCalendarSync(type) {
    const btnPreview = document.getElementById('btn-preview-events');
    const btnSync = document.getElementById('btn-sync-events');
    const btnStaff = document.getElementById('btn-sync-staff');
    
    const resBox = document.getElementById('calendar-result-area');
    const resText = document.getElementById('calendar-result-text');
    const statusInd = document.getElementById('mst-sync-status-indicator');
    
    const templateSelect = document.getElementById('sync-template-select');
    const templateName = templateSelect ? templateSelect.value : "Default";
    const calendarSelect = document.getElementById('mst-sync-calendar-select');
    
    let targetId = calendarSelect.value;
    if (!targetId) {
        alert("Please select a Target Calendar first.");
        return;
    }

    btnPreview.disabled = true;
    btnSync.disabled = true;
    btnStaff.disabled = true;
    
    statusInd.style.display = 'block';
    statusInd.innerHTML = 'üîÑ Processing... Please wait.';
    resBox.style.display = 'none';
    
    let selectedRows = null;
    let func = '';
    let args = [];

    if (type === 'preview') {
        currentSyncCalendarId = targetId; 
        func = 'api_previewSheetToCalendar';
        args = [templateName, targetId];
    } 
    else if (type === 'execute') {
        if (!currentSyncCalendarId) currentSyncCalendarId = targetId;
        
        const checks = document.querySelectorAll('.sync-check:checked');
        if (checks.length === 0) {
            alert("No changes selected.");
            resetSyncUI();
            return;
        }
        selectedRows = Array.from(checks).map(c => parseInt(c.value));
        func = 'api_syncSheetToCalendar';
        args = [templateName, selectedRows, currentSyncCalendarId];
    } 
    else if (type === 'events') {
        currentSyncCalendarId = targetId;
        func = 'api_syncSheetToCalendar';
        args = [templateName, null, targetId];
    } 
    else {
        func = 'api_syncStaffToCalendar';
        args = [targetId]; 
    }
    
    google.script.run.withSuccessHandler(function(res) {
        resetSyncUI();
        resBox.style.display = 'block';
        
        let html = "";

        if (res.warnings && res.warnings.length > 0) {
            html += `<div style="background:#fff3cd; color:#856404; padding:10px; border:1px solid #ffeeba; border-radius:4px; margin-bottom:15px;">
                <strong>‚ö†Ô∏è Validation Warnings (${res.warnings.length})</strong>
                <ul style="margin:5px 0 0 20px; padding:0; font-size:0.9em;">`;
            res.warnings.forEach(w => { html += `<li>Row ${w.row}: ${w.message}</li>`; });
            html += `</ul></div>`;
        }

        // RENDER EXECUTION REPORT (UPDATED: Shows Title)
        if (!res.isPreview && res.results) {
            html += `<h4>Execution Report</h4>`;
            html += `<p>${res.message}</p>`;
            
            if (res.results.length > 0) {
                html += `<div style="max-height:400px; overflow-y:auto; border:1px solid #ddd;">
                <table class="sync-table">
                    <thead><tr><th>Event</th><th>Status</th><th>Details</th></tr></thead>
                    <tbody>`;
                res.results.forEach(r => {
                    html += `<tr><td><strong>${r.title}</strong></td><td>${r.status}</td><td>${r.details}</td></tr>`;
                });
                html += `</tbody></table></div>`;
            }
        }
        // RENDER PREVIEW
        else if (res.isPreview && res.changes) {
            currentSyncPreview = res.changes; 
            html += `<h4>Proposed Changes (${res.changes.length})</h4>`;
            
            if (res.changes.length > 0) {
                html += `<div style="max-height:400px; overflow-y:auto; border:1px solid #ddd;">
                <table class="sync-table">
                    <thead>
                        <tr>
                            <th style="width:30px;"><input type="checkbox" checked onchange="toggleAllSync(this)"></th>
                            <th>Row</th>
                            <th>Action</th>
                            <th>Course</th>
                            <th>Details</th>
                        </tr>
                    </thead>
                    <tbody>`;
                
                res.changes.forEach(c => { 
                    let badgeClass = c.action === 'CREATE' ? 'create' : (c.action === 'RECREATE' ? 'recreate' : 'update');
                    html += `<tr>
                        <td><input type="checkbox" class="sync-check" value="${c.row}" checked></td>
                        <td>${c.row}</td>
                        <td><span class="badge ${badgeClass}">${c.action}</span></td>
                        <td><strong>${c.title}</strong></td>
                        <td>`;
                    if (c.diffs && c.diffs.length > 0) {
                        c.diffs.forEach(d => {
                            html += `<div><span style="color:#666; font-size:0.9em;">${d.field}:</span> <span class="diff-old">${d.old}</span> <span class="diff-arrow">‚Üí</span> <span class="diff-new">${d.new}</span></div>`;
                        });
                    } else {
                        html += `<span style="color:#999;">${c.details}</span>`;
                    }
                    html += `</td></tr>`; 
                });
                html += `</tbody></table></div>`;
                
                html += `<div class="sync-actions">
                    <span>Check the boxes above to confirm changes.</span>
                    <button class="button primary" onclick="handleCalendarSync('execute')">‚úÖ Apply Selected Changes</button>
                </div>`;
            } else { 
                html += `<p>No changes detected. Calendar is in sync.</p>`; 
            }
        } else { 
            html += `<p>${res.message}</p>`; 
        }
        
        resText.innerHTML = html;
        resBox.style.borderLeft = res.success ? "5px solid #007934" : "5px solid #c00";
        statusInd.style.display = 'none';

      }).withFailureHandler(function(err) { 
          resetSyncUI();
          resBox.style.display = 'block'; 
          resBox.style.borderLeft = "5px solid #c00"; 
          resText.textContent = "System Error: " + err.message; 
          statusInd.style.display = 'none';
      })[func](...args);
  }

  function resetSyncUI() {
    document.getElementById('btn-preview-events').disabled = false;
    document.getElementById('btn-sync-events').disabled = false;
    document.getElementById('btn-sync-staff').disabled = false;
    document.getElementById('mst-sync-status-indicator').style.display = 'none';
  }

  function toggleAllSync(source) {
      const checks = document.querySelectorAll('.sync-check');
      checks.forEach(c => c.checked = source.checked);
  }

  // --- MST INSPECTOR LOGIC ---
  
  function loadMSTInspectorCalendars() {
      const select = document.getElementById('mst-inspect-calendar-select');
      if(!select) return;
      
      const containerId = 'mst-inspect-cal-container';
      let container = document.getElementById(containerId);
      
      if (!container) {
          container = document.createElement('div');
          container.id = containerId;
          container.style.cssText = "max-height: 150px; overflow-y: auto; border: 1px solid #ccc; padding: 5px; background: #fff; margin-bottom: 10px;";
          container.innerHTML = '<p style="color:#666; font-size:0.9em;">Loading calendars...</p>';
          select.parentNode.replaceChild(container, select);
      }

      google.script.run.withSuccessHandler(function(res) {
          if (res.success && res.data) { 
              container.innerHTML = '';
              const allDiv = document.createElement('div');
              allDiv.innerHTML = `<label style="font-weight:bold;"><input type="checkbox" onchange="toggleInspectCalendars(this)"> Select All</label><hr style="margin: 5px 0;">`;
              container.appendChild(allDiv);

              res.data.forEach(cal => { 
                  const div = document.createElement('div');
                  div.innerHTML = `<label><input type="checkbox" class="inspect-cal-check" value="${cal.id}"> ${cal.name}</label>`;
                  container.appendChild(div); 
              }); 
          } else {
              container.innerHTML = '<p style="color:red;">Error loading calendars.</p>';
          }
      }).getAllViewableCalendars();
  }

  function toggleInspectCalendars(source) {
      const checks = document.querySelectorAll('.inspect-cal-check');
      checks.forEach(c => c.checked = source.checked);
  }

  function handleInspectCalendar() {
    const start = document.getElementById('inspect-start-date').value;
    const end = document.getElementById('inspect-end-date').value;
    const checks = document.querySelectorAll('.inspect-cal-check:checked');
    const calIds = Array.from(checks).map(c => c.value);
    
    const btn = document.getElementById('btn-inspect-cal');
    const container = document.getElementById('inspect-results');
    const filterBar = document.getElementById('inspect-filter-bar');
    const exportBtn = document.getElementById('btn-export-cal');
    
    if (!start || !end) { ui_setStatus('inspect-status', 'Please select both Start and End dates.', 'error'); return; }
    if (calIds.length === 0) { ui_setStatus('inspect-status', 'Please select at least one Calendar.', 'error'); return; }
    
    btn.disabled = true;
    container.innerHTML = '<p>Fetching events from Google Calendar...</p>';
    ui_setStatus('inspect-status', `Scanning ${calIds.length} calendars...`, 'loading');
    
    google.script.run.withSuccessHandler(function(res) {
      btn.disabled = false;
      if (res.success) { 
          ui_setStatus('inspect-status', `Found ${res.data.length} events.`, 'success'); 
          currentInspectData = res.data; 
          if(filterBar) filterBar.style.display = 'flex'; 
          if(exportBtn) exportBtn.style.display = 'inline-block'; 
          applyInspectFilters(); 
      } else { 
          ui_setStatus('inspect-status', res.message, 'error'); 
          container.innerHTML = ''; 
      }
    }).withFailureHandler(function(e) { 
        btn.disabled = false; 
        ui_setStatus('inspect-status', 'Server Error: ' + e.message, 'error'); 
    }).api_inspector_getEvents(calIds, start, end);
  }

  function loadEventTypes() {
    const container = document.getElementById('inspect-type-filters');
    if(!container) return;
    google.script.run.withSuccessHandler(function(res) {
        if(res.success && res.data) {
            eventTypes = res.data;
            container.innerHTML = '';
            if(eventTypes.length === 0) { container.innerHTML = '<span style="color:#666;">No types defined in "Event_Types" tab.</span>'; return; }
            eventTypes.forEach((type, idx) => { const wrapper = document.createElement('div'); wrapper.style.display = 'flex'; wrapper.style.alignItems = 'center'; const cb = document.createElement('input'); cb.type = 'checkbox'; cb.id = 'type-filter-' + idx; cb.value = idx; cb.addEventListener('change', applyInspectFilters); const label = document.createElement('label'); label.htmlFor = 'type-filter-' + idx; label.textContent = type.name; label.style.marginLeft = '5px'; label.style.cursor = 'pointer'; wrapper.appendChild(cb); wrapper.appendChild(label); container.appendChild(wrapper); });
        }
    }).withFailureHandler(function(e) { container.innerHTML = '<span style="color:red;">Failed to load types.</span>'; }).api_getEventTypes();
  }

  function applyInspectFilters() {
    const excludeVal = document.getElementById('filter-exclude').value.toLowerCase();
    const selectedIndices = [];
    document.querySelectorAll('#inspect-type-filters input:checked').forEach(cb => { selectedIndices.push(parseInt(cb.value)); });
    
    currentFilteredData = currentInspectData.filter(evt => {
        if (excludeVal && (evt.title.toLowerCase().includes(excludeVal) || evt.location.toLowerCase().includes(excludeVal))) return false;
        
        if (selectedIndices.length > 0) {
            let matchFound = false;
            for (let i = 0; i < selectedIndices.length; i++) {
                const typeObj = eventTypes[selectedIndices[i]];
                const keywords = typeObj.keywords.split(',').map(k => k.trim().toLowerCase());
                if (keywords.some(k => evt.title.toLowerCase().includes(k))) { matchFound = true; break; }
            }
            if (!matchFound) return false;
        }
        return true;
    });
    renderInspectTable(currentFilteredData);
  }

  function renderInspectTable(events) {
    const container = document.getElementById('inspect-results');
    if (!events || events.length === 0) { container.innerHTML = '<p>No events found matching criteria.</p>'; return; }
    
    let html = `<p style="font-size:0.8em; color:#666;">Showing ${events.length} events.</p>`;
    html += '<table class="data-table" style="font-size: 0.85rem;"><thead><tr><th>Calendar</th><th>Title</th><th>Start</th><th>End</th><th>Location</th><th>Guests</th></tr></thead><tbody>';
    
    events.forEach(evt => { 
        const startStr = evt.start.replace(':00 ', ' '); 
        const endStr = evt.end.split(',')[1] || evt.end; 
        html += `<tr>
            <td><span style="font-size:0.8em; background:#eee; padding:2px 4px; border-radius:3px;">${evt.calendarName}</span></td>
            <td><strong>${evt.title}</strong></td>
            <td>${startStr}</td>
            <td>${endStr}</td>
            <td>${evt.location}</td>
            <td style="color: #666; font-style: italic;">${evt.guests}</td>
        </tr>`; 
    });
    html += '</tbody></table>';
    container.innerHTML = html;
  }
  
  function handleExportCalendarData() {
      if (!currentFilteredData || currentFilteredData.length === 0) { ui_setStatus('inspect-status', 'No data to export.', 'error'); return; }
      const btn = document.getElementById('btn-export-cal');
      btn.disabled = true;
      btn.innerText = "Exporting...";
      google.script.run.withSuccessHandler(function(res) { btn.disabled = false; btn.innerText = "Export Visible to Sheet"; if (res.success) { ui_setStatus('inspect-status', 'Export Complete.', 'success'); window.open(res.url, '_blank'); } else { ui_setStatus('inspect-status', res.message, 'error'); } }).withFailureHandler(function(e) { btn.disabled = false; btn.innerText = "Export Visible to Sheet"; ui_setStatus('inspect-status', 'Export Failed: ' + e.message, 'error'); }).api_inspector_exportEvents(currentFilteredData);
  }

  // --- BULK EDITOR ---
  function handleLoadSheetData() {
    ui_setStatus('bulk-status', 'Loading Sheet Data...', 'loading');
    const container = document.getElementById('bulk-data-container');
    const actionBar = document.getElementById('bulk-action-bar');
    container.innerHTML = '<p>Loading...</p>';
    google.script.run.withSuccessHandler(function(res) {
      if (res.success) {
        ui_setStatus('bulk-status', `Loaded ${res.rows.length} rows.`, 'success');
        currentSheetData = res.rows;
        currentSheetHeaders = res.headers;
        const colSelect = document.getElementById('bulk-col-select');
        colSelect.innerHTML = '';
        res.headers.forEach((h, i) => { const opt = document.createElement('option'); opt.value = i; opt.text = h; colSelect.appendChild(opt); });
        renderBulkTable();
        actionBar.style.display = 'flex';
      } else { ui_setStatus('bulk-status', res.message, 'error'); container.innerHTML = ''; }
    }).withFailureHandler(function(e) { ui_setStatus('bulk-status', 'Server Error: ' + e.message, 'error'); }).api_fetchSheetData();
  }

  function renderBulkTable() {
    const container = document.getElementById('bulk-data-container');
    if (!currentSheetData || currentSheetData.length === 0) { container.innerHTML = '<p>No data.</p>'; return; }
    let html = '<div style="overflow-x:auto;"><table class="data-table" style="font-size:0.8rem;"><thead><tr>';
    html += '<th><input type="checkbox" onchange="toggleAllBulk(this)"></th>';
    currentSheetHeaders.forEach(h => html += `<th>${h}</th>`);
    html += '</tr></thead><tbody>';
    currentSheetData.forEach((rowObj, idx) => { html += `<tr><td><input type="checkbox" class="bulk-check" data-idx="${idx}"></td>`; rowObj.data.forEach(cell => { const txt = (cell && cell.length > 30) ? cell.substring(0, 30) + '...' : cell; html += `<td>${txt}</td>`; }); html += `</tr>`; });
    html += '</tbody></table></div>';
    container.innerHTML = html;
  }

  function toggleAllBulk(source) { const checks = document.querySelectorAll('.bulk-check'); checks.forEach(c => c.checked = source.checked); }

  function handleApplyBulkEdit() {
    const colIndex = parseInt(document.getElementById('bulk-col-select').value);
    const newValue = document.getElementById('bulk-val-input').value;
    const checks = document.querySelectorAll('.bulk-check:checked');
    if (checks.length === 0) { ui_setStatus('bulk-status', 'No rows selected.', 'error'); return; }
    ui_confirm(`Update ${checks.length} rows? This will change the Sheet immediately.`, function(result) {
        if (result) {
            ui_setStatus('bulk-status', 'Updating Sheet...', 'loading');
            const updates = [];
            checks.forEach(c => { const arrayIdx = parseInt(c.getAttribute('data-idx')); const rowObj = currentSheetData[arrayIdx]; updates.push({ rowIndex: rowObj.rowIndex, colIndex: colIndex, value: newValue }); });
            google.script.run.withSuccessHandler(function(res) { if (res.success) { ui_setStatus('bulk-status', res.message + ' Please run Sync to update Calendar.', 'success'); handleLoadSheetData(); } else { ui_setStatus('bulk-status', res.message, 'error'); } }).withFailureHandler(function(e) { ui_setStatus('bulk-status', 'Server Error: ' + e.message, 'error'); }).api_bulkUpdateSheet(updates);
        }
    });
  }

  // --- INITIALIZATION HOOK ---
  document.addEventListener('DOMContentLoaded', function() {
      const inspectorTab = document.querySelector('.tab-nav-item[onclick*="tab-an-inspector"]');
      if (inspectorTab) {
          inspectorTab.addEventListener('click', loadMSTInspectorCalendars);
      }
  });
</script>