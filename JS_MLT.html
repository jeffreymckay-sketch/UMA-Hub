<script>
  /**
   * -------------------------------------------------------------------
   * MLT PROCTORING CLIENT LOGIC
   * -------------------------------------------------------------------
   */

  function mlt_refreshDocList(type) {
      const container = document.getElementById('mlt-doc-list');
      container.innerHTML = '<div class="status-message loading">Loading documents...</div>';
      
      const handler = function(res) {
          if (res.error) { container.innerHTML = `<div class="status-message error">Error: ${res.error}</div>`; return; }
          if (res.data.length === 0) { 
              container.innerHTML = `<div style="text-align:center; padding:30px; color:#666; background:#f9f9f9; border-radius:8px;">
                                        <div style="font-size:2rem; margin-bottom:10px;">üìÑ</div>
                                        <p>No documents found.</p>
                                        <p style="font-size:0.85em;">Click 'Generate All' to create new reports.</p>
                                     </div>`; 
              return; 
          }
          
          let html = '<div class="doc-list-container">';
          res.data.forEach(doc => { 
              html += `
              <div class="doc-card">
                 <div class="doc-card-left">
                     <div class="doc-card-icon">üìÑ</div>
                     <a href="${doc.url}" target="_blank" class="doc-card-link" title="Open Google Doc">${doc.name}</a>
                 </div>
                 <div class="doc-card-actions">
                     <button class="button secondary btn-sm" onclick="mlt_editAccommodations('${doc.id}', '${doc.name}')" title="Edit Accommodations">‚úèÔ∏è Accommodations</button>
                     <button class="button btn-icon-only" onclick="mlt_regenerateDoc('${doc.id}')" title="Regenerate Document">üîÑ</button>
                 </div>
              </div>`; 
          });
          html += '</div>';
          container.innerHTML = html;
      };

      if (type === 'active') { 
          google.script.run.withSuccessHandler(handler).mlt_getActiveDocsList(); 
      } else { 
          google.script.run.withSuccessHandler(handler).mlt_getDocsFromFolder(); 
      }
  }

  function mlt_handleGenerateAll() { 
      ui_confirm("Generate ALL MLT documents? This will overwrite existing files.", function(yes) { 
          if(yes) { 
              ui_setStatus('mlt-status', 'Generating documents...', 'loading'); 
              google.script.run.withSuccessHandler(function(res) { 
                  ui_setStatus('mlt-status', res.data || res.error, res.error ? 'error' : 'success'); 
                  mlt_refreshDocList('active'); 
              }).mlt_generateAllDocuments(); 
          } 
      }); 
  }

  function mlt_handleRefreshAll() {
      ui_setStatus('mlt-status', 'Refreshing active documents...', 'loading');
      google.script.run.withSuccessHandler(function(res) {
          ui_setStatus('mlt-status', res.data || res.error, res.error ? 'error' : 'success');
      }).mlt_refreshAllActiveDocs();
  }
  
  // --- INDIVIDUAL DOC ACTIONS ---

  function mlt_regenerateDoc(id) {
      ui_setStatus('mlt-status', 'Regenerating document...', 'loading');
      google.script.run.withSuccessHandler(function(res) {
          ui_setStatus('mlt-status', res.data || res.error, res.error ? 'error' : 'success');
      }).mlt_regenerateSingleDocById(id);
  }

  function mlt_editAccommodations(docId, docName) {
      navigateTo('page-mlt-accom-editor');
      document.getElementById('mlt-accom-doc-name').textContent = docName;
      document.getElementById('mlt-accom-doc-id').value = docId;
      document.getElementById('mlt-accom-area').value = "Loading...";
      
      google.script.run.withSuccessHandler(function(res) {
          document.getElementById('mlt-accom-area').value = res.data || "";
      }).mlt_getAccommodations(docId);
  }

  function mlt_handleSaveAccommodations() {
      const docId = document.getElementById('mlt-accom-doc-id').value;
      const text = document.getElementById('mlt-accom-area').value;
      ui_setStatus('mlt-accom-status', 'Saving...', 'loading');
      
      google.script.run.withSuccessHandler(function(res) {
          ui_setStatus('mlt-accom-status', 'Saved.', 'success');
      }).mlt_saveAccommodations(docId, text);
  }

  // --- MLT SETTINGS ---

  function mlt_loadSettings() {
      google.script.run.withSuccessHandler(function(res) {
          if (res.success) {
              const s = res.data;
              document.getElementById('mlt-sheet-url').value = s.spreadsheetUrl || '';
              document.getElementById('mlt-folder-url').value = s.targetFolderId || '';
              document.getElementById('mlt-report-email').value = s.reportEmail || '';
              document.getElementById('mlt-custom-notes').value = s.customNotes || '';
              document.getElementById('mlt-calendar-id-input').value = s.calendarId || '';
              
              if (s.config) {
                  document.getElementById('mlt-config-json').value = JSON.stringify(s.config, null, 2);
              }
          }
      }).mlt_getSettingsData();
  }

  function mlt_handleSaveSettings() {
      const jsonStr = document.getElementById('mlt-config-json').value;
      let configObj = {};
      try {
          configObj = JSON.parse(jsonStr);
      } catch (e) {
          ui_setStatus('mltSettings-status', 'Invalid JSON in Configuration.', 'error');
          return;
      }

      const settings = {
          spreadsheetUrl: document.getElementById('mlt-sheet-url').value,
          targetFolderId: document.getElementById('mlt-folder-url').value,
          reportEmail: document.getElementById('mlt-report-email').value,
          customNotes: document.getElementById('mlt-custom-notes').value,
          calendarId: document.getElementById('mlt-calendar-id-input').value, // Also save here
          config: configObj
      };

      ui_setStatus('mltSettings-status', 'Saving...', 'loading');
      google.script.run.withSuccessHandler(function(res) {
          ui_setStatus('mltSettings-status', res.message, res.success ? 'success' : 'error');
      }).mlt_saveSettings(settings);
  }

  // --- MLT CALENDAR ---
  
  function mlt_loadCalendarOptions() {
      google.script.run.withSuccessHandler(function(res) {
          const select = document.getElementById('mlt-calendar-select');
          if(!select) return;
          
          select.innerHTML = '<option value="" disabled selected>Select a Calendar...</option>';
          
          if (res.success && res.data) { 
              res.data.forEach(cal => { 
                  const option = document.createElement('option'); 
                  option.value = cal.id; 
                  option.text = cal.name; 
                  select.appendChild(option); 
              }); 
              
              const currentId = document.getElementById('mlt-calendar-id-input').value;
              if(currentId) select.value = currentId;
          }
      }).getWritableCalendars();
  }

  function mlt_handleCalendarSync() {
      const calId = document.getElementById('mlt-calendar-id-input').value;
      const start = document.getElementById('mlt-cal-start').value;
      const end = document.getElementById('mlt-cal-end').value;
      const overwrite = document.getElementById('mlt-cal-overwrite').checked;

      if (!calId || !start || !end) {
          ui_setStatus('mlt-calendar-status', 'Please enter Calendar ID and Date Range.', 'error');
          return;
      }

      ui_confirm("Publish MLT exams to Calendar? This may delete existing events if Overwrite is checked.", function(yes) {
          if (yes) {
              ui_setStatus('mlt-calendar-status', 'Publishing...', 'loading');
              google.script.run.withSuccessHandler(function(res) {
                  ui_setStatus('mlt-calendar-status', res.message, res.success ? 'success' : 'error');
              }).mlt_syncExamsToCalendar(calId, start, end, overwrite);
          }
      });
  }
</script>