<script>
  /**
   * Main entry point for the Dashboard page.
   * This now renders the page using pre-fetched data from the global 'g' object.
   */
  function loadDashboard() {
    const dashboardView = document.getElementById('page-Dashboard');
    // Check if the content has already been rendered.
    if (dashboardView.childElementCount > 0 && !dashboardView.querySelector('.loader-ring')) {
      return;
    }

    console.log("Loading Dashboard page from pre-fetched data...");

    // Check if the dashboard data exists in our global cache.
    if (!g.dashboardData || g.dashboardData.error) {
      dashboardView.innerHTML = `<div class="error-message">Could not load Dashboard. The initial data load may have failed. Error: ${g.dashboardData ? g.dashboardData.error : 'Unknown'}</div>`;
      return;
    }

    renderDashboard(g.dashboardData); // Render using the cached data
  }

  // --- Render Functions ---
  function renderDashboard(data) {
    const { availability, preferences } = data;
    const dashboardView = document.getElementById('page-Dashboard');
    dashboardView.innerHTML = ''; // Clear loader

    const availabilityWidget = document.createElement('div');
    availabilityWidget.className = 'widget';
    availabilityWidget.innerHTML = buildAvailabilityHtml(availability);
    dashboardView.appendChild(availabilityWidget);

    const preferencesWidget = document.createElement('div');
    preferencesWidget.className = 'widget';
    preferencesWidget.innerHTML = buildPreferencesHtml(preferences);
    dashboardView.appendChild(preferencesWidget);
  }

  function buildAvailabilityHtml(availabilityData) {
    let tableRows = availabilityData.map(slot => `
      <tr>
        <td>${slot.day}</td>
        <td>${slot.start || 'N/A'}</td>
        <td>${slot.end || 'N/A'}</td>
        <td><button class="button-danger" onclick="deleteAvailability('${slot.id}')">Delete</button></td>
      </tr>`).join('');

    const days = ["Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday", "Sunday"];
    const dayOptions = days.map(d => `<option value="${d}">${d}</option>`).join('');

    return `
      <h2>My Weekly Availability</h2>
      <table class="data-table">
        <thead><tr><th>Day</th><th>Start Time</th><th>End Time</th><th>Action</th></tr></thead>
        <tbody>${tableRows.length > 0 ? tableRows : '<tr><td colspan="4" style="text-align:center;">No availability set.</td></tr>'}</tbody>
      </table>
      <div class="form-container">
        <h3>Add New Availability</h3>
        <form id="add-availability-form" class="inline-form">
          <select name="day" required>${dayOptions}</select>
          <input type="time" name="start" required>
          <input type="time" name="end" required>
          <button type="button" onclick="addAvailability()">Add Slot</button>
        </form>
      </div>
    `;
  }

  function buildPreferencesHtml(preferencesData) {
    const days = ["Monday", "Tuesday", "Wednesday", "Thursday", "Friday"];
    const timeSlots = ["Morning", "Afternoon", "Evening"];
    const options = ["Yes Please", "No Thanks", "Eh, Sure"];

    let tableRows = days.map(day => {
      let cells = timeSlots.map(slot => {
        const timeBlock = `${day}_${slot}`;
        const currentPref = preferencesData[timeBlock] || 'Eh, Sure';
        let selectOptions = options.map(opt => 
          `<option value="${opt}" ${opt === currentPref ? 'selected' : ''}>${opt}</option>`
        ).join('');
        return `<td><select name="${timeBlock}">${selectOptions}</select></td>`;
      }).join('');
      return `<tr><th>${day}</th>${cells}</tr>`;
    }).join('');

    return `
      <h2>My Work Preferences</h2>
      <p>Let us know what time blocks work best for you.</p>
      <form id="preferences-form">
        <table class="data-table preferences-table">
          <thead><tr><th></th><th>Morning</th><th>Afternoon</th><th>Evening</th></tr></thead>
          <tbody>${tableRows}</tbody>
        </table>
        <div class="form-actions">
          <button type="button" class="button-primary" onclick="savePreferences()">Save Preferences</button>
        </div>
      </form>
    `;
  }

  // --- Client-to-Server Communication (for updates, not for loading) ---

  function handleBackendResponse(response) {
    if (response.success) {
        // Instead of reloading the whole dashboard, we just need to update the 'g' object
        // and re-render. For now, we will just alert and ask the user to refresh for simplicity.
        // A more advanced implementation would re-fetch and redraw just this component.
        alert(response.message + " The view will update on next page load.");
        // To fully update the UI without a full reload, we would need to call api_getInitialAppData again
        // and re-process, which is too complex for this change.
    } else {
        showError(response.message);
    }
  }

  function addAvailability() {
    const form = document.getElementById('add-availability-form');
    const formData = Object.fromEntries(new FormData(form).entries());
    if (!formData.day || !formData.start || !formData.end) {
      alert('Please fill out all availability fields.');
      return;
    }
    google.script.run.withSuccessHandler(handleBackendResponse).withFailureHandler(showError).api_addAvailability(formData);
  }

  function deleteAvailability(recordId) {
    if (!confirm('Are you sure you want to delete this slot?')) return;
    google.script.run.withSuccessHandler(handleBackendResponse).withFailureHandler(showError).api_deleteAvailability(recordId);
  }

  function savePreferences() {
    const form = document.getElementById('preferences-form');
    const formData = Object.fromEntries(new FormData(form).entries());
    google.script.run.withSuccessHandler(handleBackendResponse).withFailureHandler(showError).api_updateStaffPreferences(formData);
  }
  
  function showError(message, error) {
    console.error('Error received:', message, error);
    alert('An error occurred: ' + message);
  }

</script>