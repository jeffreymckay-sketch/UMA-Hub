<script>
  /**
   * Main entry point for the Dashboard page.
   * Implements on-demand loading for dashboard data.
   */
  function loadDashboardPage() {
    const dashboardView = document.getElementById('page-Dashboard');

    // 1. Check if data is already cached in the global object
    if (g.dashboardData && !g.dashboardData.error) {
      console.log("Rendering Dashboard from cached data.");
      renderDashboard(g.dashboardData);
      return;
    }

    // 2. If not cached, fetch it from the server
    console.log("Fetching dashboard data on-demand...");
    dashboardView.innerHTML = '<div class="loader-ring"></div>'; // Show loader

    google.script.run
      .withSuccessHandler(handleDashboardDataSuccess)
      .withFailureHandler(handleDashboardDataFailure)
      .api_getDashboardData();
  }

  /**
   * SUCCESS HANDLER
   * Called when api_getDashboardData() returns successfully.
   * @param {object} response The success object from the server.
   */
  function handleDashboardDataSuccess(response) {
    if (response.success) {
      console.log("Dashboard data received, caching and rendering.");
      g.dashboardData = response.data; // Cache the data globally
      renderDashboard(g.dashboardData);
    } else {
      // Handle cases where the server-side function runs but returns a business logic error
      handleDashboardDataFailure({ message: response.message });
    }
  }

  /**
   * FAILURE HANDLER
   * Called when api_getDashboardData() fails to execute.
   * @param {object} error The error object from the server.
   */
  function handleDashboardDataFailure(error) {
    console.error("Failed to load Dashboard data:", error.message);
    const dashboardView = document.getElementById('page-Dashboard');
    dashboardView.innerHTML = `<div class="error-message">Could not load Dashboard. Error: ${error.message}</div>`;
  }

  // --- Render Functions (Remain largely the same) ---

  function renderDashboard(data) {
    const { availability, preferences } = data;
    const dashboardView = document.getElementById('page-Dashboard');
    dashboardView.innerHTML = ''; // Clear loader or previous content

    const availabilityWidget = document.createElement('div');
    availabilityWidget.className = 'widget';
    availabilityWidget.innerHTML = buildAvailabilityHtml(availability);
    dashboardView.appendChild(availabilityWidget);

    const preferencesWidget = document.createElement('div');
    preferencesWidget.className = 'widget';
    preferencesWidget.innerHTML = buildPreferencesHtml(preferences);
    dashboardView.appendChild(preferencesWidget);
  }

  function buildAvailabilityHtml(availabilityData) {
    let tableRows = availabilityData.map(slot => `
      <tr>
        <td>${slot.day}</td>
        <td>${slot.start || 'N/A'}</td>
        <td>${slot.end || 'N/A'}</td>
        <td><button class="button-danger" onclick="deleteAvailability('${slot.id}')">Delete</button></td>
      </tr>`).join('');

    const days = ["Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday", "Sunday"];
    const dayOptions = days.map(d => `<option value="${d}">${d}</option>`).join('');

    return `
      <h2>My Weekly Availability</h2>
      <table class="data-table">
        <thead><tr><th>Day</th><th>Start Time</th><th>End Time</th><th>Action</th></tr></thead>
        <tbody>${tableRows.length > 0 ? tableRows : '<tr><td colspan="4" style="text-align:center;">No availability set.</td></tr>'}</tbody>
      </table>
      <div class="form-container">
        <h3>Add New Availability</h3>
        <form id="add-availability-form" class="inline-form">
          <select name="day" required>${dayOptions}</select>
          <input type="time" name="start" required>
          <input type="time" name="end" required>
          <button type="button" onclick="addAvailability()">Add Slot</button>
        </form>
      </div>
    `;
  }

  function buildPreferencesHtml(preferencesData) {
    const days = ["Monday", "Tuesday", "Wednesday", "Thursday", "Friday"];
    const timeSlots = ["Morning", "Afternoon", "Evening"];
    const options = ["Yes Please", "No Thanks", "Eh, Sure"];

    let tableRows = days.map(day => {
      let cells = timeSlots.map(slot => {
        const timeBlock = `${day}_${slot}`;
        const currentPref = preferencesData[timeBlock] || 'Eh, Sure';
        let selectOptions = options.map(opt => 
          `<option value="${opt}" ${opt === currentPref ? 'selected' : ''}>${opt}</option>`
        ).join('');
        return `<td><select name="${timeBlock}">${selectOptions}</select></td>`;
      }).join('');
      return `<tr><th>${day}</th>${cells}</tr>`;
    }).join('');

    return `
      <h2>My Work Preferences</h2>
      <p>Let us know what time blocks work best for you.</p>
      <form id="preferences-form">
        <table class="data-table preferences-table">
          <thead><tr><th></th><th>Morning</th><th>Afternoon</th><th>Evening</th></tr></thead>
          <tbody>${tableRows}</tbody>
        </table>
        <div class="form-actions">
          <button type="button" class="button-primary" onclick="savePreferences()">Save Preferences</button>
        </div>
      </form>
    `;
  }

  // --- Client-to-Server Communication (for updates, not for loading) ---

  function handleUpdateResponse(response) {
    if (response.success) {
      alert(response.message);
      // Invalidate the cache so the next load gets fresh data
      g.dashboardData = null; 
      loadDashboardPage(); // Reload the dashboard view to show the change
    } else {
      showError(response.message);
    }
  }

  function addAvailability() {
    const form = document.getElementById('add-availability-form');
    const formData = Object.fromEntries(new FormData(form).entries());
    if (!formData.day || !formData.start || !formData.end) {
      alert('Please fill out all availability fields.');
      return;
    }
    google.script.run.withSuccessHandler(handleUpdateResponse).withFailureHandler(showError).api_addAvailability(formData);
  }

  function deleteAvailability(recordId) {
    if (!confirm('Are you sure you want to delete this slot?')) return;
    google.script.run.withSuccessHandler(handleUpdateResponse).withFailureHandler(showError).api_deleteAvailability(recordId);
  }

  function savePreferences() {
    const form = document.getElementById('preferences-form');
    const formData = Object.fromEntries(new FormData(form).entries());
    google.script.run.withSuccessHandler(handleUpdateResponse).withFailureHandler(showError).api_updateStaffPreferences(formData);
  }

  function showError(message, error) {
    console.error('Error received:', message, error);
    alert('An error occurred: ' + message);
  }

</script>