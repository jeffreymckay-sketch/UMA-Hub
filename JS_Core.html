<script>
  // --- GLOBAL VARIABLES ---
  var lastSearchData = null;
  var schedulingDataCache = null;
  var userAccessMatrix = {};
  var currentUserRole = 'Staff';
  var allStaffList = []; 
  var currentTemplates = [];
  var currentInspectData = [];
  var currentFilteredData = [];
  var eventTypes = []; 
  var currentSheetData = [];
  var currentSheetHeaders = [];

  // --- STARTUP & INITIALIZATION ---
  document.addEventListener('DOMContentLoaded', function() {
    // Modal Listeners
    var confirmBtn = document.getElementById('modal-confirm-btn');
    var cancelBtn = document.getElementById('modal-cancel-btn');
    if (confirmBtn) confirmBtn.addEventListener('click', function() { ui_modal_result(true); });
    if (cancelBtn) cancelBtn.addEventListener('click', function() { ui_modal_result(false); });

    // UI Initializers
    try {
        if (typeof nursing_populateHourDropdown === 'function') nursing_populateHourDropdown();
        
        var freqDropdown = document.getElementById('nursing-auto-frequency');
        if (freqDropdown) {
          freqDropdown.addEventListener('change', function() {
            document.getElementById('nursing-auto-day-group').style.display = (this.value === 'WEEKLY') ? 'block' : 'none';
          });
        }
        
        const excludeInput = document.getElementById('filter-exclude');
        if(excludeInput && typeof applyInspectFilters === 'function') excludeInput.addEventListener('input', applyInspectFilters);

        // Date Defaults
        const today = new Date();
        const sixMonthsLater = new Date(today.getFullYear(), today.getMonth() + 6, today.getDate());
        const formatDate = (date) => date.toISOString().split('T')[0];
        
        const startDateInput = document.getElementById('roster-start-date');
        const endDateInput = document.getElementById('roster-end-date');
        if(startDateInput) startDateInput.value = formatDate(today);
        if(endDateInput) endDateInput.value = formatDate(sixMonthsLater);

        const inspStart = document.getElementById('inspect-start-date');
        const inspEnd = document.getElementById('inspect-end-date');
        if(inspStart) inspStart.value = formatDate(today);
        if(inspEnd) {
            const nextWeek = new Date();
            nextWeek.setDate(nextWeek.getDate() + 7);
            inspEnd.value = formatDate(nextWeek);
        }
    } catch (e) { console.error("Error initializing UI elements: " + e.message); }

    // Data Loading
    try { loadLogo(); } catch(e) {}
    try { loadAllSettings(); } catch(e) {}
    try { if(typeof loadEventTypes === 'function') loadEventTypes(); } catch(e) {}
    
    // Load Dashboard Data Immediately
    try { if(typeof loadMyAvailability === 'function') loadMyAvailability(); } catch(e) {}
    try { if(typeof loadMyPreferences === 'function') loadMyPreferences(); } catch(e) {}
  });

  // --- GLOBAL CLICK HANDLER ---
  window.onclick = function(event) {
    if (!event.target.matches('.multi-select-button')) {
      var dropdowns = document.getElementsByClassName("multi-select-dropdown");
      for (var i = 0; i < dropdowns.length; i++) {
        var openDropdown = dropdowns[i];
        if (openDropdown.classList.contains('show')) {
          openDropdown.classList.remove('show');
        }
      }
    }
  }

  // --- UI HELPERS ---
  var ui_modal_callback = null;
  
  function ui_setStatus(elementId, msg, type) {
    var el = document.getElementById(elementId);
    if (!el) return;
    el.className = 'status-message ' + type;
    el.textContent = msg;
    if (type !== 'loading' && type !== 'error') { setTimeout(function() { el.className = 'status-message'; }, 3000); }
  }

  function ui_confirm(message, callback) {
    ui_modal_callback = callback;
    document.getElementById('modal-message').textContent = message;
    document.getElementById('custom-modal-overlay').style.display = 'flex';
  }

  function ui_modal_result(result) {
    document.getElementById('custom-modal-overlay').style.display = 'none';
    if (ui_modal_callback) { ui_modal_callback(result); }
    ui_modal_callback = null; 
  }

  // --- SIDEBAR TOGGLE ---
  function toggleSidebar() {
      document.getElementById('app-sidebar').classList.toggle('closed');
  }

  function toggleNavGroup(header) {
      // Toggle 'open' class on header
      header.classList.toggle('open');
      
      // Find next sibling (the ul)
      const subMenu = header.nextElementSibling;
      if (subMenu && subMenu.classList.contains('nav-sub-menu')) {
          subMenu.classList.toggle('open');
      }
  }

  // --- NAVIGATION ---
  function navigateTo(pageId) {
    document.querySelectorAll('.page').forEach(p => p.classList.remove('active-page'));
    document.getElementById(pageId).classList.add('active-page');
    document.querySelectorAll('.nav-item').forEach(item => {
      item.classList.remove('active');
      if (item.getAttribute('onclick') === "navigateTo('" + pageId + "')") item.classList.add('active');
    });
    
    // Page Specific Triggers
    if (pageId === 'page-dashboard') {
        if(typeof loadMyAvailability === 'function') loadMyAvailability();
        if(typeof loadMyPreferences === 'function') loadMyPreferences();
    }
    if (pageId === 'page-tech-hub' || pageId === 'page-mst') {
        if(typeof loadSchedulingRosterData === 'function') loadSchedulingRosterData();
    }
    if (pageId === 'page-mst' && typeof loadCurrentCalendarSettings === 'function') {
        loadCurrentCalendarSettings();
    }
    if (pageId === 'page-exams' && typeof nursing_refreshDocList === 'function') {
        nursing_refreshDocList('active');
    }
    if (pageId === 'page-settings') {
        if(typeof loadRoleAssignmentData === 'function') loadRoleAssignmentData();
        if(typeof loadPermissionsMatrix === 'function') loadPermissionsMatrix();
        if(typeof updateLookerStudioLink === 'function') updateLookerStudioLink();
    }
    if (pageId === 'page-analytics' && typeof analytics_init === 'function') {
        analytics_init();
    }
    // NEW: Calendar Inspector (formerly Event Discovery in Settings)
    if (pageId === 'page-inspector' && typeof discovery_init === 'function') {
        discovery_init();
    }
  }

  function navigateToSubTab(element, tabId) {
    var parent = element.closest('.page');
    parent.querySelectorAll('.tab-page').forEach(p => p.classList.remove('active'));
    parent.querySelector('#' + tabId).classList.add('active');
    parent.querySelectorAll('.tab-nav-item').forEach(i => i.classList.remove('active'));
    element.classList.add('active');
  }

  // --- BOOTLOADER ---
  function loadLogo() {
    google.script.run.withSuccessHandler(function(settings) {
      if (settings && settings.logoFileId) {
        google.script.run.withSuccessHandler(function(response) {
            if (response.data) {
              document.getElementById('logo-img').src = response.data;
              document.getElementById('logo-img').style.visibility = 'visible';
              document.getElementById('logo-loading-text').style.display = 'none';
            }
        }).getImageDataUrl(settings.logoFileId);
      } else { document.getElementById('logo-loading-text').textContent = 'No Logo Set'; }
    }).getSettings('adminSettings');
  }

  function loadAllSettings() {
    google.script.run.withSuccessHandler(handleAccessControlData).withFailureHandler(function(e){ console.error("Access Control Failed:", e); }).api_getAccessControlData(); 
    google.script.run.withSuccessHandler(function(response) { if (response.success && response.data) { mapSettingsToUI(response.data); } }).api_getAllSettings();
    
    if(typeof loadCalendarOptions === 'function') loadCalendarOptions();
    if(typeof loadSourceTabOptions === 'function') loadSourceTabOptions(); 
    
    google.script.run.withSuccessHandler(function(r){ 
        if(r.data){ 
            document.getElementById('nursing-auto-report-toggle').checked=r.data.isAuto; 
            document.getElementById('nursing-auto-frequency').dispatchEvent(new Event('change')); 
        } 
    }).nursing_getEmailSettings();
  }

  function handleAccessControlData(accessData) {
    if (accessData.error) {
        document.querySelector('.main-content').innerHTML = `<h1>Access Error</h1><p>${accessData.error}</p><p>Please contact an Admin.</p>`;
        document.querySelectorAll('.nav-menu').forEach(menu => menu.style.display = 'none');
        return;
    }
    currentUserRole = accessData.userRole; 
    userAccessMatrix = accessData.matrix; 
    document.querySelectorAll('.nav-item').forEach(item => {
        const pageIdMatch = item.getAttribute('onclick').match(/navigateTo\('([^']+)'/);
        if (pageIdMatch && pageIdMatch[1]) {
            const pageKey = pageIdMatch[1];
            if (userAccessMatrix[pageKey] && !userAccessMatrix[pageKey][currentUserRole]) { item.style.display = 'none'; }
        }
    });
    if (currentUserRole === 'Admin' || currentUserRole === 'Lead') { 
        document.getElementById('settings-role-assignment-nav').style.display = 'block'; 
        document.getElementById('admin-staff-selector-container').style.display = 'block';
        if(typeof loadStaffSelector === 'function') loadStaffSelector();
    }
    if (currentUserRole === 'Admin') { document.getElementById('settings-permissions-matrix-nav').style.display = 'block'; }
    if ((currentUserRole === 'Admin' || currentUserRole === 'Lead') && typeof loadRoleAssignmentData === 'function') { loadRoleAssignmentData(); }
  }
</script>