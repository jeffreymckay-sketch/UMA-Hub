<script>
  // --- Global Data Cache ---
  const g = {
    userInfo: null,
    dashboardData: null,
    mstData: null,
    allSettings: {},
    writableCalendars: null,
    allCalendars: null, // NEW: Holds the read-only calendar list
    nursingData: null,
  };

  // --- Page Router & Initializer ---
  const menuItems = [
    { id: 'Dashboard', title: 'Dashboard' },
    {
      id: 'Logistics',
      title: 'Logistics',
      children: [
        { id: 'MST', title: 'MST' },
        { id: 'TechHub', title: 'Tech Hub' }
      ]
    },
    {
      id: 'Proctoring',
      title: 'Proctoring',
      children: [
        { id: 'Nursing', title: 'Nursing' }
      ]
    },
    { id: 'Reporting', title: 'Stats & Reports' },
    { id: 'Zoom', title: 'Zoom' },
    { id: 'Settings', title: 'Settings' }
  ];

  document.addEventListener('DOMContentLoaded', function() {
    console.log("Initializing application...");
    buildMenu();

    google.script.run
      .withSuccessHandler(handleInitialDataSuccess)
      .withFailureHandler(handleInitialError)
      .api_getInitialAppData();

    window.addEventListener('popstate', function(e) {
      const pageId = window.location.hash.substring(1) || 'Dashboard';
      navigateToPage(pageId);
    });
  });

  function handleInitialDataSuccess(response) {
    if (response && response.success) {
      console.log("Initial data loaded successfully:", response.data);
      
      g.userInfo = response.data.userInfo;
      g.mstData = response.data.mstData;
      g.allSettings = response.data.settings || {};
      g.writableCalendars = response.data.writableCalendars;
      g.allCalendars = response.data.allCalendars; // NEW: Capture the calendar list
      g.nursingData = response.data.nursingData;

      populateUserInfo(); 

      const initialPage = window.location.hash.substring(1) || 'Dashboard';
      navigateToPage(initialPage, true);

      document.getElementById('loader').style.display = 'none';

    } else {
      const msg = (response && response.message) ? response.message : "Server returned no data.";
      handleInitialError({ message: msg });
    }
  }

  function handleInitialError(error) {
    console.error("Catastrophic failure during initial data load:", error);
    document.getElementById('loader').innerHTML = '<div style="padding:20px; text-align:center; color:red;">Failed to load application data.<br>' + (error.message || 'Unknown Error') + '</div>';
  }

  // --- Core Navigation ---

  function buildMenu() {
    const menu = document.getElementById('main-menu');
    menu.innerHTML = '';
    menuItems.forEach(item => {
      const link = document.createElement('a');
      link.className = 'nav-item';
      link.href = '#' + item.id;
      link.dataset.pageId = item.id;

      if (item.children && item.children.length > 0) {
        link.classList.add('has-submenu');
        link.id = `nav-toggle-${item.id}`;
        link.innerHTML = `${item.title} <span class="submenu-arrow">&#9654;</span>`;
        link.href = '#'; 

        const subMenu = document.createElement('div');
        subMenu.className = 'sub-menu';
        subMenu.id = `submenu-${item.id}`;
        item.children.forEach(child => {
          const childLink = document.createElement('a');
          childLink.href = '#' + child.id;
          childLink.className = 'nav-item';
          childLink.dataset.pageId = child.id;
          childLink.textContent = child.title;
          subMenu.appendChild(childLink);
        });

        const menuContainer = document.createElement('div');
        menuContainer.className = 'submenu-container';
        menuContainer.appendChild(link);
        menuContainer.appendChild(subMenu);
        menu.appendChild(menuContainer);
      } else {
        link.textContent = item.title;
        menu.appendChild(link);
      }
    });

    menu.addEventListener('click', function(e) {
      const target = e.target.closest('.nav-item');
      if (!target) return;
      e.preventDefault();
      e.stopPropagation();

      if (target.classList.contains('has-submenu')) {
        toggleSubmenu(target.id.replace('nav-toggle-', ''));
      } else if (target.dataset.pageId) {
        navigateToPage(target.dataset.pageId);
      }
    });
  }

  function toggleSubmenu(menuId) {
    const link = document.getElementById(`nav-toggle-${menuId}`);
    const submenu = document.getElementById(`submenu-${menuId}`);
    if (link && submenu) {
      link.classList.toggle('open');
      submenu.classList.toggle('open');
    }
  }

  function navigateToPage(pageId, isInitialLoad = false) {
    document.querySelectorAll('.page-view').forEach(page => page.style.display = 'none');
    const targetPage = document.getElementById('page-' + pageId);
    if (targetPage) {
      targetPage.style.display = 'block';
    } else {
      document.getElementById('page-Dashboard').style.display = 'block';
      pageId = 'Dashboard';
    }

    if (window.location.hash.substring(1) !== pageId) {
      window.history.pushState({ pageId }, '', '#' + pageId);
    }

    updateActiveMenu(pageId, isInitialLoad);

    if (pageId === 'Dashboard') {
      if(typeof loadDashboardPage === 'function') loadDashboardPage();
    } else if (pageId === 'MST') {
      if(typeof loadMstPage === 'function') loadMstPage();
    } else if (pageId === 'Nursing') {
      if(typeof loadNursingPage === 'function') loadNursingPage();
    } else if (pageId === 'Reporting') {
      if(typeof loadReportingPage === 'function') loadReportingPage();
    }
  }

  function updateActiveMenu(pageId, isInitialLoad) {
    document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
    const activeItem = document.querySelector(`[data-page-id="${pageId}"]`);
    if (activeItem) {
      activeItem.classList.add('active');
      const parentSubMenu = activeItem.closest('.sub-menu');
      if (parentSubMenu) {
        const parentId = parentSubMenu.id.replace('submenu-', '');
        const parentLink = document.getElementById(`nav-toggle-${parentId}`);
        if (parentLink) {
          parentLink.classList.add('active');
          if (isInitialLoad) {
            toggleSubmenu(parentId);
          }
        }
      }
    }
  }
  
  function openTab(evt, tabName) {
    let i, tabcontent, tablinks;
    const parentPage = evt.currentTarget.closest('.page-view');
    
    tabcontent = parentPage.getElementsByClassName("tab-content");
    for (i = 0; i < tabcontent.length; i++) {
        tabcontent[i].style.display = "none";
    }
    
    tablinks = parentPage.getElementsByClassName("tab-link");
    for (i = 0; i < tablinks.length; i++) {
        tablinks[i].className = tablinks[i].className.replace(" active", "");
    }
    
    document.getElementById(tabName).style.display = "block";
    evt.currentTarget.className += " active";
  }

  function toggleSidebar() {
    document.getElementById('app-sidebar').classList.toggle('collapsed');
    document.getElementById('app-content').classList.toggle('collapsed');
  }

  function populateUserInfo() {
    const userInfo = g.userInfo || { email: 'Error', photoUrl: '' };
    if (userInfo.email && !userInfo.error) {
       document.getElementById('user-email').textContent = userInfo.email;
    } else {
       document.getElementById('user-email').textContent = "Error";
    }
    if (userInfo.photoUrl) {
      const photo = document.getElementById('user-photo');
      photo.src = userInfo.photoUrl;
      photo.style.display = 'block';
    }
  }
</script>