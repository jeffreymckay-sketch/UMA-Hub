<script>
  // --- Page Router & Initializer ---
  const menuItems = [
    { id: 'Dashboard', title: 'Dashboard' },
    {
      id: 'Logistics',
      title: 'Logistics',
      children: [
        { id: 'MST', title: 'MST' },
        { id: 'TechHub', title: 'Tech Hub' }
      ]
    },
    { id: 'Proctoring', title: 'Proctoring' },
    { id: 'Zoom', title: 'Zoom' },
    { id: 'Settings', title: 'Settings' }
  ];

  /**
   * Runs when the document is fully loaded.
   */
  document.addEventListener('DOMContentLoaded', function() {
    buildMenu();
    const initialPage = getUrlParameter('page') || 'Dashboard';
    navigateToPage(initialPage, true); // Pass true for initial load

    google.script.run
      .withSuccessHandler(populateUserInfo)
      .withFailureHandler(handleInitialError)
      .api_getUserInfo();
  });

  /**
   * Builds the main navigation menu and sets up a single, delegated click listener.
   */
  function buildMenu() {
    const menu = document.getElementById('main-menu');
    menu.innerHTML = ''; // Clear existing items
    const baseUrl = location.origin + location.pathname;

    menuItems.forEach(item => {
      const link = document.createElement('a');
      link.className = 'nav-item';

      if (item.children && item.children.length > 0) {
        link.href = '#'; 
        link.classList.add('has-submenu');
        link.id = `nav-toggle-${item.id}`;
        link.innerHTML = `${item.title} <span class="submenu-arrow">&#9654;</span>`;
        
        const subMenu = document.createElement('div');
        subMenu.className = 'sub-menu';
        subMenu.id = `submenu-${item.id}`;

        item.children.forEach(child => {
          const childLink = document.createElement('a');
          childLink.href = baseUrl + '?page=' + child.id;
          childLink.className = 'nav-item';
          childLink.dataset.pageId = child.id;
          childLink.textContent = child.title;
          subMenu.appendChild(childLink);
        });

        const menuContainer = document.createElement('div');
        menuContainer.className = 'submenu-container';
        menuContainer.appendChild(link);
        menuContainer.appendChild(subMenu);
        menu.appendChild(menuContainer);

      } else {
        link.href = baseUrl + '?page=' + item.id;
        link.dataset.pageId = item.id;
        link.textContent = item.title;
        menu.appendChild(link);
      }
    });
    
    menu.addEventListener('click', function(e) {
      const target = e.target.closest('.nav-item');
      if (!target) return;

      e.preventDefault();

      if (target.classList.contains('has-submenu')) {
        const submenuId = target.id.replace('nav-toggle-', '');
        toggleSubmenu(submenuId);
      } else if (target.dataset.pageId) {
        navigateToPage(target.dataset.pageId);
      }
    });
  }

  /**
   * Toggles an accordion submenu.
   */
  function toggleSubmenu(menuId) {
      const link = document.getElementById(`nav-toggle-${menuId}`);
      const submenu = document.getElementById(`submenu-${menuId}`);
      
      if (link && submenu) {
          link.classList.toggle('open');
          submenu.classList.toggle('open');
      }
  }

  /**
   * Navigates to a specific page view by showing/hiding the relevant divs.
   * @param {string} pageId The ID of the page to show.
   * @param {boolean} [isInitialLoad=false] - True if this is the first page load.
   */
  function navigateToPage(pageId, isInitialLoad = false) {
    document.querySelectorAll('.page-view').forEach(page => {
      page.style.display = 'none';
    });

    const targetPage = document.getElementById('page-' + pageId);
    if (targetPage) {
      targetPage.style.display = 'block';
    } else {
      document.getElementById('page-Dashboard').style.display = 'block'; // Fallback
    }

    updateActiveMenu(pageId, isInitialLoad);

    // Call the loader function for the specific page if it exists
    if (pageId === 'Dashboard') {
      loadDashboard();
    } else if (pageId === 'MST') {
      loadMstPage();
    } // Add other pages here

    if (!isInitialLoad) {
      const newUrl = location.origin + location.pathname + '?page=' + pageId;
      window.history.pushState({path: newUrl}, '', newUrl);
    }
  }

  /**
   * Updates the active state in the navigation menu.
   */
  function updateActiveMenu(pageId, isInitialLoad) {
      document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
      const activeItem = document.querySelector(`[data-page-id="${pageId}"]`);
      if (activeItem) {
        activeItem.classList.add('active');
        const parentSubMenu = activeItem.closest('.sub-menu');
        if (parentSubMenu) {
            const parentId = parentSubMenu.id.replace('submenu-', '');
            const parentLink = document.getElementById(`nav-toggle-${parentId}`);
            if (parentLink) {
                parentLink.classList.add('active');
                if (isInitialLoad) {
                  toggleSubmenu(parentId);
                }
            }
        }
      }
  }

  // --- UI & User Info Handlers ---

  function toggleSidebar() {
    document.getElementById('app-sidebar').classList.toggle('collapsed');
    document.getElementById('app-content').classList.toggle('collapsed');
  }

  function populateUserInfo(response) {
    const loader = document.getElementById('loader');
    const userInfo = response.success ? response.data : { email: 'Error', photoUrl: '' };
    if (userInfo.email) document.getElementById('user-email').textContent = userInfo.email;
    if (userInfo.photoUrl) {
      const photo = document.getElementById('user-photo');
      photo.src = userInfo.photoUrl;
      photo.style.display = 'block';
    }
    loader.style.display = 'none';
  }

  function handleInitialError(error) {
    console.error("Initial data load failed:", error);
    document.getElementById('loader').innerHTML = 'Failed to load application data.';
  }

  function getUrlParameter(name) {
    name = name.replace(/[\[]/, '\[').replace(/[\]]/, '\]');
    var regex = new RegExp('[\\?&]' + name + '=([^&#]*)');
    var results = regex.exec(location.search);
    return results === null ? '' : decodeURIComponent(results[1].replace(/\+/g, ' '));
  }

</script>