<script>
  // --- Global Data Cache ---
  // 'g' will act as our global capacitor bank, holding all pre-fetched application data.
  const g = {
    userInfo: null,
    dashboardData: null,
    mstData: null,
    mstSettings: null,
    writableCalendars: null,
  };

  // --- Page Router & Initializer ---
  const menuItems = [
    { id: 'Dashboard', title: 'Dashboard' },
    {
      id: 'Logistics',
      title: 'Logistics',
      children: [
        { id: 'MST', title: 'MST' },
        { id: 'TechHub', title: 'Tech Hub' }
      ]
    },
    { id: 'Proctoring', title: 'Proctoring' },
    { id: 'Zoom', title: 'Zoom' },
    { id: 'Settings', title: 'Settings' }
  ];

  /**
   * Runs when the document is fully loaded. This is the main startup sequence.
   */
  document.addEventListener('DOMContentLoaded', function() {
    console.log("Initializing application...");
    buildMenu();

    // Call the new, unified data endpoint to pre-load everything.
    google.script.run
      .withSuccessHandler(handleInitialDataSuccess)
      .withFailureHandler(handleInitialError)
      .api_getInitialAppData();

    // Listen for hash changes to handle back/forward browser buttons.
    window.addEventListener('popstate', function(e) {
      const pageId = window.location.hash.substring(1) || 'Dashboard';
      navigateToPage(pageId);
    });
  });

  /**
   * SUCCESS HANDLER for the main data load.
   * This function is critical. It populates our global cache ('g').
   */
  function handleInitialDataSuccess(response) {
    if (response && response.success) {
      console.log("Initial data loaded successfully:", response.data);
      // Populate the global capacitor bank
      g.userInfo = response.data.userInfo;
      g.dashboardData = response.data.dashboardData;
      g.mstData = response.data.mstData;
      g.mstSettings = response.data.mstSettings;
      g.writableCalendars = response.data.writableCalendars;

      // Now that data is loaded, populate the UI.
      populateUserInfo(); 

      // Determine the initial page from the URL hash and navigate.
      const initialPage = window.location.hash.substring(1) || 'Dashboard';
      navigateToPage(initialPage, true);

      // Everything is ready. Hide the main loader.
      document.getElementById('loader').style.display = 'none';

    } else {
      handleInitialError({ message: response.message || "An unknown error occurred on the server." });
    }
  }

  /**
   * FAILURE HANDLER for the main data load.
   */
  function handleInitialError(error) {
    console.error("Catastrophic failure during initial data load:", error);
    document.getElementById('loader').innerHTML = 'Failed to load critical application data. Please try refreshing. Error: ' + (error.message || 'Unknown');
  }

  // --- Core Navigation ---

  function buildMenu() {
    const menu = document.getElementById('main-menu');
    menu.innerHTML = '';
    menuItems.forEach(item => {
      const link = document.createElement('a');
      link.className = 'nav-item';
      link.href = '#' + item.id;
      link.dataset.pageId = item.id;

      if (item.children && item.children.length > 0) {
        link.classList.add('has-submenu');
        link.id = `nav-toggle-${item.id}`;
        link.innerHTML = `${item.title} <span class="submenu-arrow">&#9654;</span>`;
        link.href = '#'; // Parent items just toggle

        const subMenu = document.createElement('div');
        subMenu.className = 'sub-menu';
        subMenu.id = `submenu-${item.id}`;
        item.children.forEach(child => {
          const childLink = document.createElement('a');
          childLink.href = '#' + child.id;
          childLink.className = 'nav-item';
          childLink.dataset.pageId = child.id;
          childLink.textContent = child.title;
          subMenu.appendChild(childLink);
        });

        const menuContainer = document.createElement('div');
        menuContainer.className = 'submenu-container';
        menuContainer.appendChild(link);
        menuContainer.appendChild(subMenu);
        menu.appendChild(menuContainer);
      } else {
        link.textContent = item.title;
        menu.appendChild(link);
      }
    });

    menu.addEventListener('click', function(e) {
      const target = e.target.closest('.nav-item');
      if (!target) return;
      e.preventDefault();
      e.stopPropagation();

      if (target.classList.contains('has-submenu')) {
        toggleSubmenu(target.id.replace('nav-toggle-', ''));
      } else if (target.dataset.pageId) {
        navigateToPage(target.dataset.pageId);
      }
    });
  }

  function toggleSubmenu(menuId) {
    const link = document.getElementById(`nav-toggle-${menuId}`);
    const submenu = document.getElementById(`submenu-${menuId}`);
    if (link && submenu) {
      link.classList.toggle('open');
      submenu.classList.toggle('open');
    }
  }

  function navigateToPage(pageId, isInitialLoad = false) {
    document.querySelectorAll('.page-view').forEach(page => page.style.display = 'none');
    const targetPage = document.getElementById('page-' + pageId);
    if (targetPage) {
      targetPage.style.display = 'block';
    } else {
      document.getElementById('page-Dashboard').style.display = 'block';
      pageId = 'Dashboard';
    }

    if (window.location.hash.substring(1) !== pageId) {
      window.history.pushState({ pageId }, '', '#' + pageId);
    }

    updateActiveMenu(pageId, isInitialLoad);

    // Call the specific loader function for the page. 
    // These functions should now be synchronous and use data from 'g'.
    if (pageId === 'Dashboard') {
      loadDashboard();
    } else if (pageId === 'MST') {
      loadMstPage();
    }
  }

  function updateActiveMenu(pageId, isInitialLoad) {
    document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
    const activeItem = document.querySelector(`[data-page-id="${pageId}"]`);
    if (activeItem) {
      activeItem.classList.add('active');
      const parentSubMenu = activeItem.closest('.sub-menu');
      if (parentSubMenu) {
        const parentId = parentSubMenu.id.replace('submenu-', '');
        const parentLink = document.getElementById(`nav-toggle-${parentId}`);
        if (parentLink) {
          parentLink.classList.add('active');
          if (isInitialLoad) {
            toggleSubmenu(parentId);
          }
        }
      }
    }
  }

  // --- UI & User Info Handlers ---

  function toggleSidebar() {
    document.getElementById('app-sidebar').classList.toggle('collapsed');
    document.getElementById('app-content').classList.toggle('collapsed');
  }

  function populateUserInfo() {
    const userInfo = g.userInfo || { email: 'Error', photoUrl: '' };
    if (userInfo.email && !userInfo.error) {
       document.getElementById('user-email').textContent = userInfo.email;
    } else {
       document.getElementById('user-email').textContent = "Error";
    }
    if (userInfo.photoUrl) {
      const photo = document.getElementById('user-photo');
      photo.src = userInfo.photoUrl;
      photo.style.display = 'block';
    }
  }

</script>