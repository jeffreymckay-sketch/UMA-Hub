<script>
/**
 * ===================================================================
 * CORE APPLICATION INITIALIZER
 * ===================================================================
 */

document.addEventListener('DOMContentLoaded', initializeCoreApplication);

/**
 * Main entry point. Fetches all essential data to render the UI.
 */
function initializeCoreApplication() {
    showGlobalLoader("Loading Application Data...");
    
    google.script.run
        .withSuccessHandler(handleInitialDataSuccess)
        .withFailureHandler(handleFatalError)
        .api_getInitialAppData();

    if (typeof loadAllSettings === 'function') {
        loadAllSettings();
    }
}

/**
 * Handles the successful response from api_getInitialAppData.
 */
function handleInitialDataSuccess(response) {
    if (!response || !response.success || !response.data) {
        const errorMessage = (response && response.message) 
            ? response.message 
            : "The server returned an invalid or empty data payload.";
        handleFatalError({ message: errorMessage });
        return; 
    }

    const { access, dashboard, staff } = response.data;

    if (!access || !Array.isArray(access.pages) || !dashboard || !staff) {
        handleFatalError({ message: "Data payload from server is incomplete. Critical properties (access.pages, dashboard, or staff) are missing or invalid." });
        return;
    }

    // 1. Store global data.
    App.user = { email: access.email, role: access.userRole };
    App.accessMatrix = access.matrix;
    App.staffList = staff;

    // 2. Build the navigation.
    buildNavigation(access.pages, App.user.role, App.accessMatrix);

    // 3. Populate the dashboard.
    if (typeof populateDashboard === 'function') {
        populateDashboard(dashboard);
    }

    // 4. Populate staff selectors throughout the app.
    populateStaffSelector(staff);

    // 5. Show the default page and hide the loader.
    navigateToPage('page-dashboard');
    hideGlobalLoader();
}

/**
 * Finds and populates all staff dropdowns.
 */
function populateStaffSelector(staffList) {
    const selectors = document.querySelectorAll('.staff-selector');
    if (!selectors.length) return;

    const optionsFragment = document.createDocumentFragment();
    optionsFragment.appendChild(new Option('Select Staff...', '')); 

    if (staffList && staffList.length > 0) {
        staffList.forEach(staff => {
            const option = document.createElement('option');
            option.value = staff.id;
            option.textContent = staff.name;
            optionsFragment.appendChild(option);
        });
    }

    selectors.forEach(select => {
        select.innerHTML = ''; 
        select.appendChild(optionsFragment.cloneNode(true));
    });
}


/**
 * Builds the main navigation menu based on the user's role and permissions.
 */
function buildNavigation(pages, userRole, matrix) {
    const nav = document.getElementById('main-nav');
    if (!nav) return;
    nav.innerHTML = '';

    pages.forEach(page => {
        // --- FIX --- 
        // Defensively check that a page and its ID are valid and that a corresponding
        // permission matrix entry exists before trying to check the user's role.
        // This prevents a TypeError if a page is configured in settings but missing from the permissions sheet.
        if (page && page.id && matrix && matrix[page.id]) {
            const hasAccess = matrix[page.id][userRole];
            if (hasAccess) {
                const li = document.createElement('li');
                li.className = 'nav-item';
                li.id = `nav-${page.id}`;
                // The page ID in the HTML is prefixed with 'page-'. The onclick handler must pass this full ID.
                li.onclick = () => navigateToPage(`page-${page.id}`);
                
                if (page.icon) {
                    const icon = document.createElement('span');
                    icon.className = 'nav-icon';
                    icon.textContent = page.icon;
                    li.appendChild(icon);
                }
                
                const title = document.createElement('span');
                title.textContent = page.name;
                li.appendChild(title);

                nav.appendChild(li);
            }
        }
    });
}

/**
 * Handles page navigation, updating the active state.
 */
function navigateToPage(pageId) {
    document.querySelectorAll('.page').forEach(p => p.classList.remove('active-page'));
    document.querySelectorAll('.nav-item').forEach(li => li.classList.remove('active'));

    const targetPage = document.getElementById(pageId);
    const targetNav = document.getElementById(`nav-${pageId.replace('page-','')}`);

    if (targetPage) targetPage.classList.add('active-page');
    if (targetNav) targetNav.classList.add('active');

    const loadFunction = `load_${pageId.replace('page-', '')}`;
    if (typeof window[loadFunction] === 'function') {
        window[loadFunction]();
    }
}

/**
 * Displays a fatal, non-recoverable error to the user.
 */
function handleFatalError(error) {
    const appBody = document.querySelector('body');
    if (appBody) {
        appBody.innerHTML = `<div style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #fff; display: flex; align-items: center; justify-content: center; z-index: 9999;">
                              <div style="text-align:center; color: #d32f2f; padding: 20px; border: 1px solid #d32f2f; background: #ffebee;">
                                  <h3>Application Error</h3>
                                  <p>${error.message || 'An unknown error occurred.'}</p>
                                  <p>Please contact support or try reloading the page.</p>
                              </div>
                          </div>`;
    }
}

/** Helper to show the main loading overlay. */
function showGlobalLoader(message) {
    const loader = document.getElementById('global-loader');
    if (loader) {
        const p = loader.querySelector('p');
        if (p) p.textContent = message;
        loader.style.display = 'flex';
    }
}

/** Helper to hide the main loading overlay. */
function hideGlobalLoader() {
    const loader = document.getElementById('global-loader');
    if (loader) loader.style.display = 'none';
}

// Global App object to hold state
const App = {
    user: { email: '', role: '' },
    accessMatrix: {},
    staffList: [],
    scriptUrl: ''
};

</script>