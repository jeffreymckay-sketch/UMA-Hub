<script>
  // --- BULK EDITOR VARIABLES ---
  var currentSheetData = [];
  var currentSheetHeaders = [];

  // --- BULK EDITOR LOGIC ---
  function handleLoadSheetData() {
    // UPDATED: New IDs
    const url = document.getElementById('bulk-editor-url').value;
    const tab = document.getElementById('bulk-editor-tab').value;
    
    console.log("Bulk Editor Sending:", url, tab); // Debugging

    if (!url) { ui_setStatus('bulk-status', 'Please enter a Sheet URL.', 'error'); return; }

    ui_setStatus('bulk-status', 'Loading Sheet Data...', 'loading');
    const container = document.getElementById('bulk-data-container');
    const actionBar = document.getElementById('bulk-action-bar');
    container.innerHTML = '<p>Loading...</p>';
    
    google.script.run.withSuccessHandler(function(res) {
      if (res.success) {
        ui_setStatus('bulk-status', `Loaded ${res.rows.length} rows.`, 'success');
        currentSheetData = res.rows;
        currentSheetHeaders = res.headers;
        const colSelect = document.getElementById('bulk-col-select');
        colSelect.innerHTML = '';
        res.headers.forEach((h, i) => { const opt = document.createElement('option'); opt.value = i; opt.text = h; colSelect.appendChild(opt); });
        renderBulkTable();
        actionBar.style.display = 'flex';
      } else { ui_setStatus('bulk-status', res.message, 'error'); container.innerHTML = ''; }
    }).withFailureHandler(function(e) { ui_setStatus('bulk-status', 'Server Error: ' + e.message, 'error'); }).api_fetchSheetData(url, tab);
  }

  function renderBulkTable() {
    const container = document.getElementById('bulk-data-container');
    if (!currentSheetData || currentSheetData.length === 0) { container.innerHTML = '<p>No data.</p>'; return; }
    let html = '<div style="overflow-x:auto;"><table class="data-table" style="font-size:0.8rem;"><thead><tr>';
    html += '<th><input type="checkbox" onchange="toggleAllBulk(this)"></th>';
    currentSheetHeaders.forEach(h => html += `<th>${h}</th>`);
    html += '</tr></thead><tbody>';
    currentSheetData.forEach((rowObj, idx) => { html += `<tr><td><input type="checkbox" class="bulk-check" data-idx="${idx}"></td>`; rowObj.data.forEach(cell => { const txt = (cell && cell.length > 30) ? cell.substring(0, 30) + '...' : cell; html += `<td>${txt}</td>`; }); html += `</tr>`; });
    html += '</tbody></table></div>';
    container.innerHTML = html;
  }

  function toggleAllBulk(source) { const checks = document.querySelectorAll('.bulk-check'); checks.forEach(c => c.checked = source.checked); }

  function handleApplyBulkEdit() {
    const url = document.getElementById('bulk-editor-url').value;
    const tab = document.getElementById('bulk-editor-tab').value;
    const colIndex = parseInt(document.getElementById('bulk-col-select').value);
    const newValue = document.getElementById('bulk-val-input').value;
    const checks = document.querySelectorAll('.bulk-check:checked');
    
    if (checks.length === 0) { ui_setStatus('bulk-status', 'No rows selected.', 'error'); return; }
    
    ui_confirm(`Update ${checks.length} rows? This will change the Sheet immediately.`, function(result) {
        if (result) {
            ui_setStatus('bulk-status', 'Updating Sheet...', 'loading');
            const updates = [];
            checks.forEach(c => { const arrayIdx = parseInt(c.getAttribute('data-idx')); const rowObj = currentSheetData[arrayIdx]; updates.push({ rowIndex: rowObj.rowIndex, colIndex: colIndex, value: newValue }); });
            google.script.run.withSuccessHandler(function(res) { if (res.success) { ui_setStatus('bulk-status', res.message, 'success'); handleLoadSheetData(); } else { ui_setStatus('bulk-status', res.message, 'error'); } }).withFailureHandler(function(e) { ui_setStatus('bulk-status', 'Server Error: ' + e.message, 'error'); }).api_bulkUpdateSheet(url, tab, updates);
        }
    });
  }
  
  // --- LOOKUP LOGIC (View Builder) ---
  var lookup_cache = { headers: [], rows: [] };
  var lookup_selectedIndices = []; 
  var lookup_activeFilters = {}; 
  var lookup_sortState = { colIdx: -1, asc: true }; 
  var lookup_hiddenRows = new Set(); 

  function lookup_handleLoadConfig() {
    const url = document.getElementById('lookup-source-url').value;
    const tab = document.getElementById('lookup-source-tab').value;
    if (!url) { ui_setStatus('lookup-step-1-status', 'Please enter a Sheet URL.', 'error'); return; }
    ui_setStatus('lookup-step-1-status', 'Connecting to Sheet...', 'loading');
    google.script.run.withSuccessHandler(function(res) {
        if (res.success) {
            ui_setStatus('lookup-step-1-status', `Connected to: ${res.sourceName}`, 'success');
            lookup_cache.headers = res.headers;
            lookup_renderColumnPicker(res.headers);
            document.getElementById('lookup-step-1').style.display = 'none';
            document.getElementById('lookup-step-2').style.display = 'block';
        } else { ui_setStatus('lookup-step-1-status', res.message, 'error'); }
    }).api_lookup_getHeaders(url, tab);
  }
  function lookup_renderColumnPicker(headers) {
    const grid = document.getElementById('lookup-column-grid');
    grid.innerHTML = '';
    headers.forEach((h, i) => {
        const div = document.createElement('div');
        div.className = 'col-checkbox-item';
        div.innerHTML = `<input type="checkbox" id="col-check-${i}" value="${i}" checked><label for="col-check-${i}">${h}</label>`;
        grid.appendChild(div);
    });
  }
  function lookup_selectAllCols(select) { document.querySelectorAll('#lookup-column-grid input[type="checkbox"]').forEach(cb => cb.checked = select); }
  function lookup_resetToStep1() { document.getElementById('lookup-step-2').style.display = 'none'; document.getElementById('lookup-step-1').style.display = 'block'; }
  function lookup_handleBuildView() {
    lookup_selectedIndices = [];
    document.querySelectorAll('#lookup-column-grid input:checked').forEach(cb => { lookup_selectedIndices.push(parseInt(cb.value)); });
    if (lookup_selectedIndices.length === 0) { ui_setStatus('lookup-step-2-status', 'Please select at least one column.', 'error'); return; }
    const url = document.getElementById('lookup-source-url').value;
    const tab = document.getElementById('lookup-source-tab').value;
    ui_setStatus('lookup-step-2-status', 'Fetching data...', 'loading');
    google.script.run.withSuccessHandler(function(res) {
        if (res.success) {
            lookup_cache.rows = res.rows;
            lookup_hiddenRows.clear(); 
            ui_setStatus('lookup-step-2-status', '', 'success'); 
            document.getElementById('lookup-step-2').style.display = 'none';
            document.getElementById('lookup-step-3').style.display = 'block';
            lookup_initView();
        } else { ui_setStatus('lookup-step-2-status', res.message, 'error'); }
    }).api_lookup_getData(url, tab);
  }
  function lookup_resetToStep2() { document.getElementById('lookup-step-3').style.display = 'none'; document.getElementById('lookup-step-2').style.display = 'block'; }
  function lookup_initView() {
    const filterContainer = document.getElementById('lookup-dynamic-filters');
    const smartLinkSelect = document.getElementById('lookup-smart-link-col');
    filterContainer.innerHTML = '';
    smartLinkSelect.innerHTML = '<option value="-1">-- Select Link Column --</option>';
    lookup_activeFilters = {};
    lookup_sortState = { colIdx: -1, asc: true }; 
    lookup_selectedIndices.forEach(colIdx => {
        const headerName = lookup_cache.headers[colIdx];
        const opt = document.createElement('option'); opt.value = colIdx; opt.text = headerName; smartLinkSelect.appendChild(opt);
        const wrapper = document.createElement('div'); wrapper.className = 'filter-item';
        const label = document.createElement('label'); label.textContent = headerName;
        const btn = document.createElement('div'); btn.className = 'multi-select-button'; btn.textContent = 'All'; btn.id = `ms-btn-${colIdx}`;
        btn.onclick = function(e) { e.stopPropagation(); lookup_toggleDropdown(colIdx); };
        const dropdown = document.createElement('div'); dropdown.className = 'multi-select-dropdown'; dropdown.id = `ms-dropdown-${colIdx}`;
        const uniqueVals = new Set();
        lookup_cache.rows.forEach(r => { if(r[colIdx]) uniqueVals.add(r[colIdx]); });
        Array.from(uniqueVals).sort().forEach(v => {
            const item = document.createElement('div'); item.className = 'dropdown-option';
            item.innerHTML = `<input type="checkbox" value="${v}" onchange="lookup_updateFilter(${colIdx})"> ${v}`;
            item.onclick = function(e) { e.stopPropagation(); }
            dropdown.appendChild(item);
        });
        wrapper.appendChild(label); wrapper.appendChild(btn); wrapper.appendChild(dropdown); filterContainer.appendChild(wrapper);
    });
    lookup_applyFilters();
  }
  function lookup_toggleDropdown(colIdx) {
      var dropdowns = document.getElementsByClassName("multi-select-dropdown");
      for (var i = 0; i < dropdowns.length; i++) { if (dropdowns[i].id !== `ms-dropdown-${colIdx}`) { dropdowns[i].classList.remove('show'); } }
      document.getElementById(`ms-dropdown-${colIdx}`).classList.toggle("show");
  }
  function lookup_updateFilter(colIdx) {
      const dropdown = document.getElementById(`ms-dropdown-${colIdx}`);
      const checkboxes = dropdown.querySelectorAll('input[type="checkbox"]:checked');
      const selectedVals = Array.from(checkboxes).map(cb => cb.value);
      if (selectedVals.length > 0) { lookup_activeFilters[colIdx] = selectedVals; } else { delete lookup_activeFilters[colIdx]; }
      const btn = document.getElementById(`ms-btn-${colIdx}`);
      if (selectedVals.length === 0) { btn.textContent = "All"; } else if (selectedVals.length === 1) { btn.textContent = selectedVals[0]; } else { btn.textContent = `${selectedVals.length} selected`; }
      lookup_applyFilters();
  }
  function lookup_handleHeaderClick(colIdx) {
      if (lookup_sortState.colIdx === colIdx) { lookup_sortState.asc = !lookup_sortState.asc; } else { lookup_sortState.colIdx = colIdx; lookup_sortState.asc = true; }
      lookup_applyFilters();
  }
  function lookup_handleRemoveRow(originalIndex) { lookup_hiddenRows.add(originalIndex); lookup_applyFilters(); }
  function lookup_applyFilters() {
    let results = [];
    lookup_cache.rows.forEach((row, originalIndex) => {
        if (lookup_hiddenRows.has(originalIndex)) return;
        let match = true;
        for (const [colIdx, filterVals] of Object.entries(lookup_activeFilters)) {
            const cellVal = row[colIdx] || "";
            if (!filterVals.includes(cellVal)) { match = false; break; }
        }
        if (match) { results.push({ data: row, index: originalIndex }); }
    });
    const smartLinkEnabled = document.getElementById('lookup-smart-link-toggle').checked;
    const linkColIdx = parseInt(document.getElementById('lookup-smart-link-col').value);
    let uniqueLinkCount = 0;
    if (smartLinkEnabled && linkColIdx !== -1 && results.length > 0) {
        const targetIds = new Set();
        results.forEach(item => { if (item.data[linkColIdx]) targetIds.add(item.data[linkColIdx]); });
        uniqueLinkCount = targetIds.size;
        if (targetIds.size > 0) {
            results = []; 
            lookup_cache.rows.forEach((row, originalIndex) => {
                if (lookup_hiddenRows.has(originalIndex)) return; 
                if (targetIds.has(row[linkColIdx])) { results.push({ data: row, index: originalIndex }); }
            });
        }
    }
    results.sort((a, b) => {
        const rowA = a.data;
        const rowB = b.data;
        if (smartLinkEnabled && linkColIdx !== -1) {
            const linkA = (rowA[linkColIdx] || "").toString().toLowerCase();
            const linkB = (rowB[linkColIdx] || "").toString().toLowerCase();
            if (linkA < linkB) return -1;
            if (linkA > linkB) return 1;
        }
        if (lookup_sortState.colIdx !== -1) {
            const valA = (rowA[lookup_sortState.colIdx] || "").toString().toLowerCase();
            const valB = (rowB[lookup_sortState.colIdx] || "").toString().toLowerCase();
            if (valA < valB) return lookup_sortState.asc ? -1 : 1;
            if (valA > valB) return lookup_sortState.asc ? 1 : -1;
        }
        return 0;
    });
    lastSearchData = { headers: lookup_selectedIndices.map(i => lookup_cache.headers[i]), rows: results.map(item => lookup_selectedIndices.map(i => item.data[i])) };
    lookup_renderTable(results, uniqueLinkCount);
  }
  function lookup_renderTable(results, uniqueLinkCount) {
    const container = document.getElementById('lookup-results-table');
    const countDiv = document.getElementById('lookup-results-count');
    const smartLinkEnabled = document.getElementById('lookup-smart-link-toggle').checked;
    const linkColIdx = parseInt(document.getElementById('lookup-smart-link-col').value);
    let statusText = `Showing ${results.length} rows`;
    if (smartLinkEnabled && linkColIdx !== -1 && uniqueLinkCount > 0) {
        const headerName = lookup_cache.headers[linkColIdx];
        statusText += ` <span class="stat-highlight">(${uniqueLinkCount} Unique ${headerName}s)</span>`;
    }
    countDiv.innerHTML = statusText;
    if (results.length === 0) { container.innerHTML = '<p>No matching records found.</p>'; return; }
    const renderLimit = 500;
    const displayRows = results.slice(0, renderLimit);
    let html = '<table class="data-table"><thead><tr>';
    html += '<th>Action</th>'; 
    lookup_selectedIndices.forEach(i => {
        let sortIcon = '';
        if (lookup_sortState.colIdx === i) { sortIcon = lookup_sortState.asc ? ' ‚ñ≤' : ' ‚ñº'; }
        html += `<th class="sortable-header" onclick="lookup_handleHeaderClick(${i})">${lookup_cache.headers[i]}<span class="sort-icon">${sortIcon}</span></th>`;
    });
    html += '</tr></thead><tbody>';
    let currentGroupVal = null;
    let isGroupA = true; 
    displayRows.forEach(item => {
        const row = item.data;
        const originalIndex = item.index;
        let rowClass = '';
        if (smartLinkEnabled && linkColIdx !== -1) {
            const rowVal = row[linkColIdx];
            if (rowVal !== currentGroupVal) { isGroupA = !isGroupA; currentGroupVal = rowVal; }
            rowClass = isGroupA ? 'group-a' : 'group-b';
        }
        html += `<tr class="${rowClass}">`;
        html += `<td><button class="remove-btn" onclick="lookup_handleRemoveRow(${originalIndex})">üóëÔ∏è</button></td>`;
        lookup_selectedIndices.forEach(i => { html += `<td>${row[i] || ''}</td>`; });
        html += '</tr>';
    });
    html += '</tbody></table>';
    if (results.length > renderLimit) { html += `<p style="color:#666; font-style:italic; margin-top:10px;">(Showing first ${renderLimit} rows. Export to see all.)</p>`; }
    container.innerHTML = html;
  }
  function handleExportResults() {
      if(!lastSearchData) return;
      const btn = document.querySelector('#lookup-step-3 button.secondary');
      const originalText = btn ? btn.innerText : "Export";
      if(btn) btn.innerText = "Exporting...";
      google.script.run.withSuccessHandler(function(res) {
          if(btn) { btn.innerText = originalText; }
          if(res.success) { window.open(res.url, '_blank'); }
          else { alert("Export Failed: " + res.error); }
      }).exportToSheet(lastSearchData.headers, lastSearchData.rows);
  }
</script>