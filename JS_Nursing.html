<script>
  // --- Global State for Batching ---
  let batchState = {
    queue: [],
    total: 0,
    processed: 0,
    action: '', // 'create', 'update', or 'calendar'
    isRunning: false
  };

  function loadNursingPage() {
    // Ensure tab is active
    const docTabBtn = document.querySelector('button[onclick*="Nursing-DocManagement"]');
    if (docTabBtn) openTab({ currentTarget: docTabBtn }, 'Nursing-DocManagement');

    renderNursingSettings();
    
    // Check Data
    if (g.nursingData && g.nursingData.success) {
      renderNursingDocManagement(g.nursingData);
    } else {
      // Load if missing
      const view = document.getElementById('Nursing-DocManagement');
      view.innerHTML = '<div class="loader-container" style="position:relative; height:200px;"><div class="loader-ring"></div></div>';
      google.script.run
        .withSuccessHandler(res => {
            g.nursingData = res;
            if(res.success) renderNursingDocManagement(res);
            else view.innerHTML = `<div class="error-message">${res.message}</div>`;
        })
        .api_getNursingData();
    }
  }

  function renderNursingDocManagement(response) {
    const view = document.getElementById('Nursing-DocManagement');
    view.innerHTML = '';

    // Header
    const header = document.createElement('div');
    header.className = 'proctoring-header';
    header.innerHTML = `
      <h2 style="margin:0">Nursing Doc Management</h2>
      <div class="proctoring-actions">
        <input type="text" id="exam-search" class="form-input" placeholder="Search..." onkeyup="filterExams()" style="width:180px">
        <button id="nursing-sync-cal-btn" class="button-tertiary" onclick="handleCalendarSync('bulk')">Sync Calendar</button>
        <button id="nursing-create-btn" class="button-primary" onclick="handleBulkAction('create')">Generate All</button>
        <button id="nursing-update-btn" class="button-secondary" onclick="handleBulkAction('update')">Update All</button>
      </div>
    `;
    view.appendChild(header);

    // Group Data by Course Code
    const courses = {};
    if (response.data && response.data.sheets) {
        response.data.sheets.forEach(sheet => {
            const code = sheet.course.code || "Unknown";
            if (!courses[code]) {
                courses[code] = { name: sheet.course.name, exams: [] };
            }
            // Add sheetName to exam for callbacks
            sheet.exams.forEach(e => courses[code].exams.push({ ...e, _sheetName: sheet.sheetName }));
        });
    }

    const container = document.createElement('div');
    container.id = 'course-container';

    if (Object.keys(courses).length === 0) {
        container.innerHTML = '<div style="padding:20px; text-align:center; color:#888;">No exams found. Check sheet format.</div>';
    }

    for (const [code, data] of Object.entries(courses)) {
        container.appendChild(buildCourseSection(code, data.name, data.exams));
    }
    view.appendChild(container);
  }

  function buildCourseSection(code, name, exams) {
      const section = document.createElement('div');
      section.className = 'course-section';
      
      const header = document.createElement('div');
      header.className = 'course-header';
      header.innerHTML = `<span>${code} - ${name}</span>`;
      header.onclick = () => section.classList.toggle('open');
      
      const content = document.createElement('div');
      content.className = 'course-content';
      
      const grid = document.createElement('div');
      grid.className = 'exam-grid';
      
      exams.forEach(exam => grid.appendChild(buildExamCard(exam)));
      
      content.appendChild(grid);
      section.appendChild(header);
      section.appendChild(content);
      return section;
  }

  function buildExamCard(exam) {
      const card = document.createElement('div');
      card.className = 'exam-card';
      card.dataset.examName = (exam.name || '').toLowerCase();
      
      const safeSheet = (exam._sheetName || '').replace(/'/g, "\\'");
      const safeExam = (exam.name || '').replace(/'/g, "\\'");
      
      const hasDoc = !!exam.docUrl;
      
      // Button Logic
      let mainBtn, viewBtn;
      
      if (hasDoc) {
          mainBtn = `<button class="button-tertiary btn-sm btn-std" onclick="handleSingleAction(this, 'update', '${safeSheet}', '${safeExam}')">Update</button>`;
          viewBtn = `<a href="${exam.docUrl}" target="_blank" class="button-tertiary btn-sm btn-std">View</a>`;
      } else {
          mainBtn = `<button class="button-success btn-sm btn-std" onclick="handleSingleAction(this, 'create', '${safeSheet}', '${safeExam}')">Create</button>`;
          viewBtn = `<button class="btn-disabled btn-sm btn-std">View</button>`;
      }

      // Calendar Button Logic
      let calBtnClass = 'button-tertiary'; 
      let calBtnContent = 'ðŸ“…';

      if (exam.isOnCalendar) {
          calBtnClass = 'btn-orange'; 
          calBtnContent = 'ðŸ“… âœ”';     
      }

      card.innerHTML = `
          <div class="exam-card-header">${exam.name}</div>
          <div class="exam-card-body">
              <div class="exam-info-row"><span class="exam-label">Date:</span> <span class="exam-value">${exam.date || '-'}</span></div>
              <div class="exam-info-row"><span class="exam-label">Site Time:</span> <span class="exam-value">${exam.siteTime || '-'}</span></div>
              <div class="exam-info-row"><span class="exam-label">Zoom Time:</span> <span class="exam-value">${exam.zoomTime || '-'}</span></div>
              <div class="exam-info-row"><span class="exam-label">Password:</span> <span class="password-badge">${exam.password || '-'}</span></div>
          </div>
          <div class="exam-card-footer">
              <button class="button-tertiary btn-sm" onclick="openAccommodationsSidebar('${safeSheet}', '${safeExam}')">Accommodations</button>
              <div class="footer-right">
                  <button class="${calBtnClass} btn-sm btn-cal" title="Sync to Calendar" onclick="handleCalendarSync('single', '${safeSheet}', '${safeExam}', this)">${calBtnContent}</button>
                  ${mainBtn}
                  ${viewBtn}
              </div>
          </div>
      `;
      return card;
  }

  // --- Single Actions ---

  function handleSingleAction(btn, action, sheetName, examName) {
      btn.disabled = true;
      btn.textContent = '...';
      
      const func = action === 'create' ? 'createNursingProctoringDocuments' : 'updateAllNursingDocuments';
      
      const sheet = g.nursingData.data.sheets.find(s => s.sheetName === sheetName);
      const exam = sheet.exams.find(e => e.name === examName);
      const payload = { settings: g.nursingData.data.settings, sheets: [{ ...sheet, exams: [exam] }] };

      google.script.run
        .withSuccessHandler(res => {
            if(res.success) {
                showNotification(res.message, 'success');
                exam.docUrl = res.docUrl || exam.docUrl; 
                const newCard = buildExamCard({ ...exam, _sheetName: sheetName });
                btn.closest('.exam-card').replaceWith(newCard);
            } else {
                showNotification(res.message, 'error');
                btn.disabled = false;
                btn.textContent = action === 'create' ? 'Create' : 'Update';
            }
        })
        .withFailureHandler(err => {
            showNotification(err.message, 'error');
            btn.disabled = false;
        })
        [func](payload);
  }

  // --- Calendar Sync Logic ---

  function handleCalendarSync(type, sheetName, examName, btn) {
    if (type === 'single') {
        const originalHtml = btn.innerHTML;
        const originalClass = btn.className;
        
        btn.disabled = true;
        btn.innerHTML = '<span class="spinner-sm"></span>';
        
        const sheet = g.nursingData.data.sheets.find(s => s.sheetName === sheetName);
        const exam = sheet.exams.find(e => e.name === examName);
        const payload = { settings: g.nursingData.data.settings, sheets: [{ ...sheet, exams: [exam] }] };

        google.script.run
            .withSuccessHandler(res => {
                btn.disabled = false; 
                if (res.success) {
                    showNotification(res.message, 'success');
                    btn.className = 'btn-orange btn-sm btn-cal';
                    btn.innerHTML = 'ðŸ“… âœ”';
                    exam.isOnCalendar = true; 
                }
                else {
                    btn.innerHTML = originalHtml;
                    btn.className = originalClass;
                    showNotification(res.message, 'error');
                }
            })
            .withFailureHandler(err => {
                btn.disabled = false; 
                btn.innerHTML = originalHtml;
                btn.className = originalClass;
                showNotification(err.message, 'error');
            })
            .api_syncNursingCalendar(payload);
    } else {
        // Bulk Sync
        if (!g.nursingData || !g.nursingData.data) return;

        const allExams = [];
        g.nursingData.data.sheets.forEach(sheet => {
            sheet.exams.forEach(exam => {
                allExams.push({ sheetName: sheet.sheetName, course: sheet.course, exam: exam });
            });
        });

        if (allExams.length === 0) {
            showNotification("No exams found to sync.", "error");
            return;
        }

        batchState = { queue: allExams, total: allExams.length, processed: 0, action: 'calendar', isRunning: true };
        
        showProgressModal(true);
        document.getElementById('progress-title').textContent = "Syncing with Google Calendar...";
        updateProgressUI(0, batchState.total, "Starting sync...");
        
        processNextCalendarBatch();
    }
  }

  function processNextCalendarBatch() {
    const BATCH_SIZE = 5;
    if (batchState.processed >= batchState.total) {
        showProgressModal(false);
        showNotification("Calendar Sync Complete!", "success");
        g.nursingData = null;
        loadNursingPage();
        return;
    }

    const chunk = batchState.queue.slice(batchState.processed, batchState.processed + BATCH_SIZE);
    
    const tempSheetsMap = {};
    chunk.forEach(item => {
        if (!tempSheetsMap[item.sheetName]) {
            tempSheetsMap[item.sheetName] = { sheetName: item.sheetName, course: item.course, exams: [] };
        }
        tempSheetsMap[item.sheetName].exams.push(item.exam);
    });

    const payload = { settings: g.nursingData.data.settings, sheets: Object.values(tempSheetsMap) };

    updateProgressUI(batchState.processed, batchState.total, `Syncing items ${batchState.processed + 1} - ${Math.min(batchState.processed + BATCH_SIZE, batchState.total)}...`);

    google.script.run
        .withSuccessHandler(res => {
            if (res.success) {
                batchState.processed += chunk.length;
                processNextCalendarBatch();
            } else {
                showNotification("Sync failed: " + res.message, "error");
                showProgressModal(false);
            }
        })
        .withFailureHandler(err => {
            showNotification("Server error: " + err.message, "error");
            showProgressModal(false);
        })
        .api_syncNursingCalendar(payload);
  }

  // --- Bulk Actions ---

  function handleBulkAction(action) {
      if (!g.nursingData || !g.nursingData.data) return;

      const allExams = [];
      g.nursingData.data.sheets.forEach(sheet => {
          sheet.exams.forEach(exam => {
              allExams.push({ sheetName: sheet.sheetName, course: sheet.course, exam: exam });
          });
      });

      if (allExams.length === 0) {
          showNotification("No exams found to process.", "error");
          return;
      }

      batchState = { queue: allExams, total: allExams.length, processed: 0, action: action, isRunning: true };

      document.getElementById('nursing-create-btn').disabled = true;
      document.getElementById('nursing-update-btn').disabled = true;
      showProgressModal(true);
      document.getElementById('progress-title').textContent = "Processing Documents...";
      updateProgressUI(0, batchState.total, "Starting batch process...");

      processNextBatch();
  }

  function processNextBatch() {
      const BATCH_SIZE = 5;
      if (batchState.processed >= batchState.total) {
          finishBatchProcess();
          return;
      }

      const chunk = batchState.queue.slice(batchState.processed, batchState.processed + BATCH_SIZE);
      const tempSheetsMap = {};
      
      chunk.forEach(item => {
          if (!tempSheetsMap[item.sheetName]) {
              tempSheetsMap[item.sheetName] = { sheetName: item.sheetName, course: item.course, exams: [] };
          }
          tempSheetsMap[item.sheetName].exams.push(item.exam);
      });

      const payload = { settings: g.nursingData.data.settings, sheets: Object.values(tempSheetsMap) };
      const func = batchState.action === 'create' ? 'createNursingProctoringDocuments' : 'updateAllNursingDocuments';

      updateProgressUI(batchState.processed, batchState.total, `Processing items ${batchState.processed + 1} - ${Math.min(batchState.processed + BATCH_SIZE, batchState.total)}...`);

      google.script.run
          .withSuccessHandler(res => {
              if (res.success) {
                  batchState.processed += chunk.length;
                  updateProgressUI(batchState.processed, batchState.total, "Batch complete.");
                  processNextBatch(); 
              } else {
                  showNotification("Batch failed: " + res.message, "error");
                  finishBatchProcess(false);
              }
          })
          .withFailureHandler(err => {
              showNotification("Server error: " + err.message, "error");
              finishBatchProcess(false);
          })
          [func](payload);
  }

  function finishBatchProcess(success = true) {
      showProgressModal(false);
      document.getElementById('nursing-create-btn').disabled = false;
      document.getElementById('nursing-update-btn').disabled = false;
      if (success) {
          showNotification("All documents processed successfully!", "success");
          g.nursingData = null;
          loadNursingPage();
      }
  }

  // --- UI Helpers ---

  function showProgressModal(show) {
      // Check if modal exists, if not, create it
      let el = document.getElementById('progress-overlay');
      if (!el) {
          document.body.insertAdjacentHTML('beforeend', `
            <div id="progress-overlay" style="position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:20000; display:flex; justify-content:center; align-items:center;">
                <div class="progress-box" style="background:#fff; padding:25px; border-radius:8px; text-align:center;">
                    <h3 id="progress-title">Processing...</h3>
                    <div id="progress-stats">0 / 0</div>
                    <div style="background:#eee; height:20px; width:300px; margin:15px 0; border-radius:10px; overflow:hidden;">
                        <div id="progress-fill" style="background:green; height:100%; width:0%;"></div>
                    </div>
                    <div id="progress-subtext">Initializing...</div>
                </div>
            </div>
          `);
          el = document.getElementById('progress-overlay');
      }
      el.style.display = show ? 'flex' : 'none';
  }

  function updateProgressUI(current, total, message) {
      const pct = Math.round((current / total) * 100);
      document.getElementById('progress-stats').textContent = `${current} / ${total}`;
      document.getElementById('progress-fill').style.width = `${pct}%`;
      document.getElementById('progress-subtext').textContent = message;
  }

  function openAccommodationsSidebar(sheetName, examName) {
    const sidebar = document.getElementById('accommodations-sidebar');
    if (!sidebar) {
        showNotification("Sidebar component missing.", "error");
        return;
    }
    const overlay = document.getElementById('accommodations-overlay');
    const title = document.getElementById('accommodations-title');
    const textarea = document.getElementById('accommodations-text');
    
    sidebar.dataset.sheetName = sheetName;
    sidebar.dataset.examName = examName;
    
    let examData;
    g.nursingData.data.sheets.forEach(s => {
        if(s.sheetName === sheetName) {
            const e = s.exams.find(ex => ex.name === examName);
            if(e) examData = e;
        }
    });
    
    title.textContent = `Accommodations: ${examName}`;
    textarea.value = examData ? (examData.generalNotes || examData.accommodations || '') : '';

    overlay.classList.add('open');
    sidebar.classList.add('open');
    textarea.focus();
  }

  function closeAccommodationsSidebar() {
    document.getElementById('accommodations-sidebar').classList.remove('open');
    document.getElementById('accommodations-overlay').classList.remove('open');
  }

  function saveAccommodations() {
    const sidebar = document.getElementById('accommodations-sidebar');
    const btn = document.getElementById('accommodations-save-btn');
    const sheetName = sidebar.dataset.sheetName;
    const examName = sidebar.dataset.examName;
    const text = document.getElementById('accommodations-text').value;

    btn.disabled = true; btn.textContent = 'Saving...';
    
    // Construct payload for new DB save function
    const sheet = g.nursingData.data.sheets.find(s => s.sheetName === sheetName);
    const payload = {
        courseCode: sheet.course.code,
        examName: examName,
        generalNotes: text,
        studentTags: {} // Future feature
    };

    google.script.run
      .withSuccessHandler(res => {
          btn.disabled = false; btn.textContent = 'Save';
          if(res.success) {
              showNotification('Saved!', 'success');
              // Update local cache
               g.nursingData.data.sheets.find(s => s.sheetName === sheetName)
                   .exams.find(e => e.name === examName).generalNotes = text;
              closeAccommodationsSidebar();
          } else {
              showNotification(res.message, 'error');
          }
      })
      .api_saveNursingAccommodations(payload);
  }

  function filterExams() {
      const term = document.getElementById('exam-search').value.toLowerCase();
      document.querySelectorAll('.course-section').forEach(section => {
          let visible = 0;
          section.querySelectorAll('.exam-card').forEach(card => {
              if(card.dataset.examName.includes(term)) {
                  card.style.display = 'flex'; visible++;
              } else {
                  card.style.display = 'none';
              }
          });
          section.style.display = visible ? 'block' : 'none';
          if(term && visible) section.classList.add('open');
      });
  }
  
  function renderNursingSettings() {
      const settings = g.allSettings.nursing_settings || {};
      const view = document.getElementById('Nursing-Settings');
      view.innerHTML = `
        <h2>Nursing Proctoring Settings</h2>
        <div class="form-vertical">
            <div class="form-group"><label>Sheet ID</label><input id="nursing-sheet-id" class="form-input" value="${settings.nursingSheetId||''}"></div>
            <div class="form-group"><label>Folder ID</label><input id="nursing-folder-id" class="form-input" value="${settings.nursingFolderId||''}"></div>
            <div class="form-group">
                <label>Target Calendar ID (Email or ID)</label>
                <input id="nursing-calendar-id" class="form-input" value="${settings.nursingCalendarId||''}" placeholder="e.g. primary or xxxx@group.calendar.google.com">
            </div>
            <div class="form-group"><label>Custom Notes</label><textarea id="nursing-custom-notes" class="form-input">${settings.customNotes||''}</textarea></div>
            <button class="button-primary" onclick="saveNursingSettings(this)">Save Settings</button>
            <div id="nursing-settings-feedback"></div>
        </div>`;
  }
  
  function saveNursingSettings(btn) {
      const settings = {
          nursingSheetId: document.getElementById('nursing-sheet-id').value,
          nursingFolderId: document.getElementById('nursing-folder-id').value,
          nursingCalendarId: document.getElementById('nursing-calendar-id').value,
          customNotes: document.getElementById('nursing-custom-notes').value
      };
      btn.textContent = 'Saving...';
      google.script.run.withSuccessHandler(res => {
          btn.textContent = 'Save Settings';
          if(res.success) { 
              g.allSettings.nursing_settings = settings; 
              g.nursingData = null; 
              showNotification('Saved', 'success'); 
          }
      }).api_saveSettings('nursing_settings', settings);
  }
</script>