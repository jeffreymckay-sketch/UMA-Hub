<style>
  /* --- Nursing Tool Specific Styles --- */
  .proctoring-header {
    display: flex; justify-content: space-between; align-items: center;
    margin-bottom: 20px; padding-bottom: 15px; border-bottom: 1px solid var(--color-border-light);
  }
  .proctoring-actions { display: flex; gap: 10px; }

  /* Course Accordion */
  .course-section { margin-bottom: 15px; border: 1px solid var(--color-border-light); border-radius: 6px; background: #fff; overflow: hidden; }
  .course-header {
    padding: 12px 15px; background: var(--color-accent-gray); cursor: pointer;
    display: flex; justify-content: space-between; align-items: center;
    font-weight: 600; color: var(--color-primary-navy);
  }
  .course-header:hover { background: #e9e9e9; }
  .course-header::after { content: '\25B6'; font-size: 0.8em; transition: transform 0.2s; }
  .course-section.open .course-header::after { transform: rotate(90deg); }
  .course-content { display: none; padding: 15px; }
  .course-section.open .course-content { display: block; }

  /* Exam Cards */
  .exam-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 15px; }
  .exam-card { border: 1px solid var(--color-border-light); border-radius: 6px; display: flex; flex-direction: column; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
  .exam-card-header { padding: 10px 15px; background: #fafafa; border-bottom: 1px solid var(--color-border-light); font-weight: bold; color: var(--color-primary-navy); }
  .exam-card-body { padding: 15px; flex-grow: 1; font-size: 0.9em; }
  .exam-info-row { display: flex; justify-content: space-between; margin-bottom: 6px; }
  .exam-label { color: #666; }
  .exam-value { font-weight: 500; text-align: right; }
  .password-badge { font-family: monospace; background: #eee; padding: 2px 6px; border-radius: 4px; border: 1px solid #ddd; }
  
  .exam-card-footer { padding: 10px 15px; background: #fff; border-top: 1px solid var(--color-border-light); display: flex; justify-content: space-between; align-items: center; }
  .footer-right { display: flex; gap: 8px; }

  /* Buttons */
  .btn-sm { padding: 5px 10px; font-size: 0.85em; }
  .btn-outline { background: transparent; border: 1px solid var(--color-border-light); color: var(--color-text-dark); }
  .btn-outline:hover { background: var(--color-accent-gray); }
  .btn-create { background-color: var(--color-primary-green); color: #fff; border: none; }
  .btn-create:hover { opacity: 0.9; }
  .btn-disabled { opacity: 0.5; cursor: not-allowed; pointer-events: none; background: #eee; color: #999; border: 1px solid #ddd; }

  /* --- Accommodations Sidebar Styles (Embedded) --- */
  #accommodations-sidebar {
    position: fixed; top: 0; right: -450px; width: 450px; max-width: 90%; height: 100%;
    background-color: #fff; box-shadow: -4px 0 15px rgba(0,0,0,0.15); z-index: 10000;
    transition: right 0.3s ease-in-out; display: flex; flex-direction: column;
  }
  #accommodations-sidebar.open { right: 0; }
  #accommodations-overlay {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background-color: rgba(0,0,0,0.4); z-index: 9999; display: none; opacity: 0; transition: opacity 0.3s;
  }
  #accommodations-overlay.open { display: block; opacity: 1; }
  .accommodations-header { padding: 20px; border-bottom: 1px solid #eee; background: var(--color-primary-navy); color: #fff; }
  .accommodations-content { padding: 20px; flex-grow: 1; display: flex; flex-direction: column; }
  .accommodations-content textarea { flex-grow: 1; padding: 10px; border: 1px solid #ccc; border-radius: 4px; resize: none; font-family: inherit; }
  .accommodations-footer { padding: 20px; border-top: 1px solid #eee; text-align: right; }
</style>

<!-- Accommodations Sidebar HTML -->
<div id="accommodations-overlay" onclick="closeAccommodationsSidebar()"></div>
<div id="accommodations-sidebar">
  <div class="accommodations-header">
    <h3 id="accommodations-title" style="margin:0; font-size:1.1em;">Edit Accommodations</h3>
  </div>
  <div class="accommodations-content">
    <textarea id="accommodations-text" placeholder="Enter individual accommodations for this exam..."></textarea>
  </div>
  <div class="accommodations-footer">
    <button class="button-secondary" onclick="closeAccommodationsSidebar()">Cancel</button>
    <button id="accommodations-save-btn" class="button-primary" onclick="saveAccommodations()">Save</button>
  </div>
</div>

<script>
  function loadNursingPage() {
    // Ensure tab is active
    const docTabBtn = document.querySelector('button[onclick*="Nursing-DocManagement"]');
    if (docTabBtn) openTab({ currentTarget: docTabBtn }, 'Nursing-DocManagement');

    renderNursingSettings();
    
    // Check Data
    if (g.nursingData && g.nursingData.success) {
      renderNursingDocManagement(g.nursingData);
    } else {
      // Load if missing
      const view = document.getElementById('Nursing-DocManagement');
      view.innerHTML = '<div class="loader-container" style="position:relative; height:200px;"><div class="loader-ring"></div></div>';
      google.script.run
        .withSuccessHandler(res => {
            g.nursingData = res;
            if(res.success) renderNursingDocManagement(res);
            else view.innerHTML = `<div class="error-message">${res.message}</div>`;
        })
        .api_getNursingData();
    }
  }

  function renderNursingDocManagement(response) {
    const view = document.getElementById('Nursing-DocManagement');
    view.innerHTML = '';

    // Header
    const header = document.createElement('div');
    header.className = 'proctoring-header';
    header.innerHTML = `
      <h2 style="margin:0">Nursing Doc Management</h2>
      <div class="proctoring-actions">
        <input type="text" id="exam-search" class="form-input" placeholder="Search..." onkeyup="filterExams()" style="width:180px">
        <button id="nursing-create-btn" class="button-primary" onclick="handleBulkAction('create')">Generate All</button>
        <button id="nursing-update-btn" class="button-secondary" onclick="handleBulkAction('update')">Update All</button>
      </div>
    `;
    view.appendChild(header);

    // Group Data by Course Code
    const courses = {};
    if (response.data && response.data.sheets) {
        response.data.sheets.forEach(sheet => {
            const code = sheet.course.code || "Unknown";
            if (!courses[code]) {
                courses[code] = { name: sheet.course.name, exams: [] };
            }
            // Add sheetName to exam for callbacks
            sheet.exams.forEach(e => courses[code].exams.push({ ...e, _sheetName: sheet.sheetName }));
        });
    }

    const container = document.createElement('div');
    container.id = 'course-container';

    if (Object.keys(courses).length === 0) {
        container.innerHTML = '<div style="padding:20px; text-align:center; color:#888;">No exams found. Check sheet format.</div>';
    }

    for (const [code, data] of Object.entries(courses)) {
        container.appendChild(buildCourseSection(code, data.name, data.exams));
    }
    view.appendChild(container);
  }

  function buildCourseSection(code, name, exams) {
      const section = document.createElement('div');
      section.className = 'course-section';
      
      const header = document.createElement('div');
      header.className = 'course-header';
      header.innerHTML = `<span>${code} - ${name}</span>`;
      header.onclick = () => section.classList.toggle('open');
      
      const content = document.createElement('div');
      content.className = 'course-content';
      
      const grid = document.createElement('div');
      grid.className = 'exam-grid';
      
      exams.forEach(exam => grid.appendChild(buildExamCard(exam)));
      
      content.appendChild(grid);
      section.appendChild(header);
      section.appendChild(content);
      return section;
  }

  function buildExamCard(exam) {
      const card = document.createElement('div');
      card.className = 'exam-card';
      card.dataset.examName = (exam.name || '').toLowerCase();
      
      const safeSheet = (exam._sheetName || '').replace(/'/g, "\\'");
      const safeExam = (exam.name || '').replace(/'/g, "\\'");
      
      const hasDoc = !!exam.docUrl;
      
      // Button Logic
      let mainBtn, viewBtn;
      
      if (hasDoc) {
          mainBtn = `<button class="button-tertiary btn-sm" onclick="handleSingleAction(this, 'update', '${safeSheet}', '${safeExam}')">Update</button>`;
          viewBtn = `<a href="${exam.docUrl}" target="_blank" class="button-tertiary btn-sm">View</a>`;
      } else {
          mainBtn = `<button class="button-success btn-sm" onclick="handleSingleAction(this, 'create', '${safeSheet}', '${safeExam}')">Create</button>`;
          viewBtn = `<button class="btn-disabled btn-sm">View</button>`;
      }

      card.innerHTML = `
          <div class="exam-card-header">${exam.name}</div>
          <div class="exam-card-body">
              <div class="exam-info-row"><span class="exam-label">Date:</span> <span class="exam-value">${exam.date ? new Date(exam.date).toLocaleDateString() : '-'}</span></div>
              <div class="exam-info-row"><span class="exam-label">Site Time:</span> <span class="exam-value">${exam.siteTime || '-'}</span></div>
              <div class="exam-info-row"><span class="exam-label">Zoom Time:</span> <span class="exam-value">${exam.zoomTime || '-'}</span></div>
              <div class="exam-info-row"><span class="exam-label">Password:</span> <span class="password-badge">${exam.password || '-'}</span></div>
          </div>
          <div class="exam-card-footer">
              <button class="button-tertiary btn-sm" onclick="openAccommodationsSidebar('${safeSheet}', '${safeExam}')">Accommodations</button>
              <div class="footer-right">
                  ${mainBtn}
                  ${viewBtn}
              </div>
          </div>
      `;
      return card;
  }

  // --- Actions ---

  function handleSingleAction(btn, action, sheetName, examName) {
      btn.disabled = true;
      btn.textContent = '...';
      
      const func = action === 'create' ? 'createNursingProctoringDocuments' : 'updateAllNursingDocuments';
      
      // Reconstruct payload
      const sheet = g.nursingData.data.sheets.find(s => s.sheetName === sheetName);
      const exam = sheet.exams.find(e => e.name === examName);
      const payload = { settings: g.nursingData.data.settings, sheets: [{ ...sheet, exams: [exam] }] };

      google.script.run
        .withSuccessHandler(res => {
            if(res.success) {
                showNotification(res.message, 'success');
                // Update local data
                exam.docUrl = res.docUrl || exam.docUrl; // Keep old if not returned
                if (action === 'create' && res.docUrl) exam.docUrl = res.docUrl; // Ensure new URL is captured
                
                // Re-render card
                const newCard = buildExamCard({ ...exam, _sheetName: sheetName });
                btn.closest('.exam-card').replaceWith(newCard);
            } else {
                showNotification(res.message, 'error');
                btn.disabled = false;
                btn.textContent = action === 'create' ? 'Create' : 'Update';
            }
        })
        .withFailureHandler(err => {
            showNotification(err.message, 'error');
            btn.disabled = false;
        })
        [func](payload);
  }

  function handleBulkAction(action) {
      const createBtn = document.getElementById('nursing-create-btn');
      const updateBtn = document.getElementById('nursing-update-btn');
      createBtn.disabled = true; updateBtn.disabled = true;
      
      const func = action === 'create' ? 'createNursingProctoringDocuments' : 'updateAllNursingDocuments';
      
      google.script.run
        .withSuccessHandler(res => {
            showNotification(res.message, res.success ? 'success' : 'error');
            createBtn.disabled = false; updateBtn.disabled = false;
            if(res.success) {
                g.nursingData = null; // Reload
                loadNursingPage();
            }
        })
        [func](g.nursingData.data);
  }

  // --- Accommodations Sidebar Logic ---
  function openAccommodationsSidebar(sheetName, examName) {
    const sidebar = document.getElementById('accommodations-sidebar');
    const overlay = document.getElementById('accommodations-overlay');
    const title = document.getElementById('accommodations-title');
    const textarea = document.getElementById('accommodations-text');
    
    sidebar.dataset.sheetName = sheetName;
    sidebar.dataset.examName = examName;
    
    // Find data
    let examData;
    g.nursingData.data.sheets.forEach(s => {
        if(s.sheetName === sheetName) {
            const e = s.exams.find(ex => ex.name === examName);
            if(e) examData = e;
        }
    });
    
    title.textContent = `Accommodations: ${examName}`;
    textarea.value = examData ? (examData.accommodations || '') : '';

    overlay.classList.add('open');
    sidebar.classList.add('open');
    textarea.focus();
  }

  function closeAccommodationsSidebar() {
    document.getElementById('accommodations-sidebar').classList.remove('open');
    document.getElementById('accommodations-overlay').classList.remove('open');
  }

  function saveAccommodations() {
    const sidebar = document.getElementById('accommodations-sidebar');
    const btn = document.getElementById('accommodations-save-btn');
    const sheetName = sidebar.dataset.sheetName;
    const examName = sidebar.dataset.examName;
    const text = document.getElementById('accommodations-text').value;

    btn.disabled = true; btn.textContent = 'Saving...';
    
    google.script.run
      .withSuccessHandler(res => {
          btn.disabled = false; btn.textContent = 'Save';
          if(res.success) {
              showNotification('Saved!', 'success');
              // Update local cache
               g.nursingData.data.sheets.find(s => s.sheetName === sheetName)
                   .exams.find(e => e.name === examName).accommodations = text;
              closeAccommodationsSidebar();
          } else {
              showNotification(res.message, 'error');
          }
      })
      .api_saveNursingAccommodations(sheetName, examName, text);
  }

  function filterExams() {
      const term = document.getElementById('exam-search').value.toLowerCase();
      document.querySelectorAll('.course-section').forEach(section => {
          let visible = 0;
          section.querySelectorAll('.exam-card').forEach(card => {
              if(card.dataset.examName.includes(term)) {
                  card.style.display = 'flex'; visible++;
              } else {
                  card.style.display = 'none';
              }
          });
          section.style.display = visible ? 'block' : 'none';
          if(term && visible) section.classList.add('open');
      });
  }
  
  // Settings (Preserved)
  function renderNursingSettings() {
      // ... (Same as before, ensure IDs match) ...
      // For brevity, assuming the previous settings render function is used or copied here.
      // If you need the full settings code again, let me know, but it was in the previous artifact.
      const settings = g.allSettings.nursing_settings || {};
      const view = document.getElementById('Nursing-Settings');
      view.innerHTML = `
        <h2>Nursing Proctoring Settings</h2>
        <div class="form-vertical">
            <div class="form-group"><label>Sheet ID</label><input id="nursing-sheet-id" class="form-input" value="${settings.nursingSheetId||''}"></div>
            <div class="form-group"><label>Folder ID</label><input id="nursing-folder-id" class="form-input" value="${settings.nursingFolderId||''}"></div>
            <div class="form-group"><label>Custom Notes</label><textarea id="nursing-custom-notes" class="form-input">${settings.customNotes||''}</textarea></div>
            <button class="button-primary" onclick="saveNursingSettings(this)">Save Settings</button>
            <div id="nursing-settings-feedback"></div>
        </div>`;
  }
  
  function saveNursingSettings(btn) {
      // ... (Standard save logic) ...
      const settings = {
          nursingSheetId: document.getElementById('nursing-sheet-id').value,
          nursingFolderId: document.getElementById('nursing-folder-id').value,
          customNotes: document.getElementById('nursing-custom-notes').value
      };
      btn.textContent = 'Saving...';
      google.script.run.withSuccessHandler(res => {
          btn.textContent = 'Save Settings';
          if(res.success) { 
              g.allSettings.nursing_settings = settings; 
              g.nursingData = null; 
              showNotification('Saved', 'success'); 
          }
      }).api_saveSettings('nursing_settings', settings);
  }
</script>