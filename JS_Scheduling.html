
<script>
  // --- Globals ---
  var cachedCourseAssignments = [];
  var cachedMstStaffList = [];
  var cachedFormOptions = {};
  var courseSortState = { field: 'staffName', asc: true };
  var _confirmAction;

  // --- Core Functions ---
  function setSchedulingStatus(msg, type) {
      App.ui.setStatus('scheduling-status', msg, type);
      App.ui.setStatus('mst-status', msg, type);
  }

  function loadSchedulingRosterData() {
    setSchedulingStatus('Loading assignments...', 'loading');
    App.api.scheduling.getViewData()
        .then(renderSchedulingRoster)
        .catch(function(e) { 
            setSchedulingStatus('Error loading data: ' + e.message, 'error'); 
        });
  }

  function renderSchedulingRoster(response) {
    if (!response || !response.success) {
        var errorMessage = response && response.error ? response.error : "An unknown error occurred while loading data.";
        setSchedulingStatus(errorMessage, 'error'); 
        return; 
    }
    
    var data = response.data;
    cachedMstStaffList = data.mstStaffList || [];
    cachedFormOptions = data.formOptions || {};
    cachedCourseAssignments = data.courseAssignments || [];

    renderCourseTable();
    setSchedulingStatus(cachedCourseAssignments.length > 0 ? 'Assignments loaded successfully.' : 'No assignments to display.', 'success');
  }

  function renderCourseTable() {
      var container = document.getElementById('sched-assignments-list');
      if (!container) return;

      var html = '<div class="table-controls"><button class="button secondary" onclick="handleExportCourses()">Export to Sheet</button></div>';
      
      if (!cachedCourseAssignments || cachedCourseAssignments.length === 0) {
          container.innerHTML = html + '<p class="info-message">No course assignments found.</p>';
          return;
      }

      html += '<table class="data-table zebra-stripes"><thead><tr>' +
          '<th class="sortable-header" onclick="handleSortCourses(\'staffName\')">Assigned Staff</th>' +
          '<th class="sortable-header" onclick="handleSortCourses(\'itemName\')">Course</th>' +
          '<th class="sortable-header" onclick="handleSortCourses(\'courseFaculty\')">Faculty</th>' +
          '<th>Link</th>' +
          '<th class="sortable-header" onclick="handleSortCourses(\'courseDay\')">Day</th>' +
          '<th class="sortable-header" onclick="handleSortCourses(\'courseTime\')">Time</th>' +
          '<th>Duration</th><th>Classroom</th><th>Actions</th></tr></thead><tbody>';

      cachedCourseAssignments.forEach(function(c) {
          var staffOptions = '<option value="">-- Unassigned --</option>';
          (cachedMstStaffList || []).forEach(function(s) {
              var sel = (c.staffId && s.id && String(s.id).toLowerCase() === String(c.staffId).toLowerCase()) ? 'selected' : '';
              staffOptions += '<option value="' + s.id + '" ' + sel + '>' + s.name + '</option>';
          });

          var linkHtml = c.link ? '<a href="' + c.link + '" target="_blank" title="Open Zoom Link" class="icon-link">üîó</a>' : '';
          var encodedItemName = encodeURIComponent(c.itemName || '');

          html += '<tr>' +
              '<td>' +
                  '<div class="assignment-control">' +
                      '<select id="assign-select-' + c.id + '" class="inline-assign-select">' + staffOptions + '</select>' +
                      '<button class="button icon-only" onclick="handleInlineAssignmentUpdate(\'' + c.id + '\')" title="Save Assignment">üíæ</button>' +
                  '</div>' +
              '</td>' +
              '<td>' + (c.itemName || '') + '</td>' +
              '<td>' + (c.courseFaculty || '') + '</td>' +
              '<td class="centered">' + linkHtml + '</td>' +
              '<td>' + (c.courseDay || '') + '</td>' +
              '<td>' + (c.courseTime || '') + '</td>' +
              '<td>' + (c.duration || '') + '</td>' +
              '<td>' + (c.location || '') + '</td>' +
              '<td class="centered">' +
                  '<button class="button icon-only" onclick="handleEditCourse(\'' + c.id + '\')" title="Edit Course">‚úèÔ∏è</button>' +
                  '<button class="button icon-only danger" onclick="handleDeleteCourse(\'' + c.id + '\', \''+ encodedItemName + '\')" title="Delete Course">üóëÔ∏è</button>' +
              '</td>' +
          '</tr>';
      });
      container.innerHTML = html + '</tbody></table>';
  }

  // --- Event Handlers ---
  function handleDeleteCourse(courseId, encodedCourseName) {
      var courseName = decodeURIComponent(encodedCourseName);
      var message = 'Are you sure you want to permanently delete the course "' + courseName + '"? This action cannot be undone.';

      document.getElementById('modal-message').innerHTML = message;

      _confirmAction = function() {
          setSchedulingStatus('Deleting course...', 'loading');
          google.script.run
              .withSuccessHandler(function(res) {
                  if (res.success) {
                      setSchedulingStatus('Course deleted successfully.', 'success');
                      loadSchedulingRosterData();
                  } else {
                      setSchedulingStatus('Error deleting course: ' + res.error, 'error');
                  }
              })
              .withFailureHandler(function(e) {
                  setSchedulingStatus('Error: ' + e.message, 'error');
              })
              .api_deleteCourse(courseId);
      };

      document.getElementById('confirmation-modal-overlay').style.display = 'flex';
  }

  function handleInlineAssignmentUpdate(courseId) {
      var select = document.getElementById('assign-select-' + courseId);
      if (!select) return;
      var newStaffId = select.value;
      
      setSchedulingStatus('Updating assignment...', 'loading');
      
      google.script.run
          .withSuccessHandler(function() {
              loadSchedulingRosterData(); 
          })
          .withFailureHandler(function(e) {
              setSchedulingStatus('Update failed: ' + e.message, 'error');
          })
          .api_updateCourseAssignment(courseId, newStaffId);
  }
  
  function handleSortCourses(field) {
      courseSortState.asc = (courseSortState.field === field) ? !courseSortState.asc : true;
      courseSortState.field = field;
      
      (cachedCourseAssignments || []).sort(function(a, b) {
          var valA = (a[field] || '').toString().toLowerCase();
          var valB = (b[field] || '').toString().toLowerCase();
          if (valA < valB) return courseSortState.asc ? -1 : 1;
          if (valA > valB) return courseSortState.asc ? 1 : -1;
          return 0;
      });

      renderCourseTable();
  }
  
  // --- Modal & Form Functions ---
  function closeConfirmationModal() {
    document.getElementById('confirmation-modal-overlay').style.display = 'none';
    _confirmAction = null;
  }

  function confirmModalAction() {
    if (typeof _confirmAction === 'function') {
      _confirmAction();
    }
    closeConfirmationModal();
  }

  function _populateSelect(elementId, options, placeholder, selectedValues) {
    var select = document.getElementById(elementId);
    if (!select) return;

    var selectedSet = new Set();
    if (selectedValues) {
        (Array.isArray(selectedValues) ? selectedValues : [selectedValues]).forEach(function(val) {
            selectedSet.add(String(val).trim());
        });
    }

    var html = '<option value="">-- ' + placeholder + ' --</option>';
    (options || []).forEach(function(opt) {
        var value = (typeof opt === 'object' && opt !== null) ? opt.id : opt;
        var name = (typeof opt === 'object' && opt !== null) ? opt.name : opt;
        var isSelected = selectedSet.has(String(value).trim());
        html += '<option value="' + value + '" ' + (isSelected ? 'selected' : '') + '>' + name + '</option>';
    });
    select.innerHTML = html;
  }

  function openAddCourseModal() {
    document.getElementById('add-course-modal-overlay').style.display = 'flex';
    _populateSelect('add-course-session', cachedFormOptions.sessions, 'Select Session');
    _populateSelect('add-course-day', cachedFormOptions.days, 'Select Day(s)');
    _populateSelect('add-course-time-of-day', cachedFormOptions.timesOfDay, 'Select Time');
    _populateSelect('add-course-location', cachedFormOptions.locations, 'Select Classroom');
    _populateSelect('add-course-staff-assigned', cachedMstStaffList, 'Assign Staff');
  }

  function closeAddCourseModal() {
    document.getElementById('add-course-modal-overlay').style.display = 'none';
    App.ui.setStatus('add-course-status', '', 'clear');
    var form = document.getElementById('add-course-form');
    if (form) form.reset();
  }

  function handleAddCourse() {
      var daysSelected = document.getElementById('add-course-day').selectedOptions;
      var days = Array.prototype.map.call(daysSelected, function(opt) { return opt.value; });

      var courseDetails = {
          session: document.getElementById('add-course-session').value,
          startDate: document.getElementById('add-course-start-date').value,
          endDate: document.getElementById('add-course-end-date').value,
          day: days.join(' / '),
          course: document.getElementById('add-course-title').value,
          faculty: document.getElementById('add-course-faculty').value,
          runTime: document.getElementById('add-course-runtime').value,
          timeOfDay: document.getElementById('add-course-time-of-day').value,
          bxLocation: document.getElementById('add-course-location').value,
          mstAssignedByEmail: document.getElementById('add-course-staff-assigned').value,
          zoomLink: document.getElementById('add-course-zoom-link').value
      };

      if (!courseDetails.course || !courseDetails.faculty) {
          App.ui.setStatus('add-course-status', 'Course Title and Faculty are required.', 'error');
          return;
      }
      
      App.ui.setStatus('add-course-status', 'Adding class...', 'loading');

      google.script.run
          .withSuccessHandler(function(res) {
              if (res.success) {
                  setSchedulingStatus('New class added successfully.', 'success');
                  closeAddCourseModal();
                  loadSchedulingRosterData();
              } else {
                  App.ui.setStatus('add-course-status', 'Error: ' + res.error, 'error');
              }
          })
          .withFailureHandler(function(e) {
              App.ui.setStatus('add-course-status', 'Error: ' + e.message, 'error');
          })
          .api_addCourse(courseDetails);
  }

  function handleEditCourse(courseId) {
    var course = cachedCourseAssignments.find(function(c) { return c.id === courseId; });
    if (!course) {
        setSchedulingStatus('Error: Could not find course data to edit.', 'error');
        return;
    }

    document.getElementById('edit-course-id').value = course.id;
    document.getElementById('edit-course-title').value = course.itemName;
    document.getElementById('edit-course-faculty').value = course.courseFaculty;
    document.getElementById('edit-course-runtime').value = course.runTime;
    document.getElementById('edit-course-zoom-link').value = course.link;
    document.getElementById('edit-course-start-date').value = course.startDate;
    document.getElementById('edit-course-end-date').value = course.endDate;
    
    var courseDays = course.courseDay ? course.courseDay.split(' / ') : [];

    _populateSelect('edit-course-session', cachedFormOptions.sessions, 'Select Session', course.session);
    _populateSelect('edit-course-day', cachedFormOptions.days, 'Select Day(s)', courseDays);
    _populateSelect('edit-course-time-of-day', cachedFormOptions.timesOfDay, 'Select Time', course.timeOfDay);
    _populateSelect('edit-course-location', cachedFormOptions.locations, 'Select Classroom', course.location);
    _populateSelect('edit-course-staff-assigned', cachedMstStaffList, 'Assign Staff', course.staffId);

    document.getElementById('edit-course-modal-overlay').style.display = 'flex';
  }

  function handleUpdateCourse() {
    var daysSelected = document.getElementById('edit-course-day').selectedOptions;
    var days = Array.prototype.map.call(daysSelected, function(opt) { return opt.value; });

    var courseDetails = {
        id: document.getElementById('edit-course-id').value,
        session: document.getElementById('edit-course-session').value,
        startDate: document.getElementById('edit-course-start-date').value,
        endDate: document.getElementById('edit-course-end-date').value,
        day: days.join(' / '),
        course: document.getElementById('edit-course-title').value,
        faculty: document.getElementById('edit-course-faculty').value,
        runTime: document.getElementById('edit-course-runtime').value,
        timeOfDay: document.getElementById('edit-course-time-of-day').value,
        bxLocation: document.getElementById('edit-course-location').value,
        mstAssignedByEmail: document.getElementById('edit-course-staff-assigned').value,
        zoomLink: document.getElementById('edit-course-zoom-link').value
    };

    if (!courseDetails.course || !courseDetails.faculty) {
        App.ui.setStatus('edit-course-status', 'Course Title and Faculty are required.', 'error');
        return;
    }

    App.ui.setStatus('edit-course-status', 'Updating class...', 'loading');

    google.script.run
        .withSuccessHandler(function(res) {
            if (res.success) {
                setSchedulingStatus('Class updated successfully.', 'success');
                closeEditCourseModal();
                loadSchedulingRosterData();
            } else {
                App.ui.setStatus('edit-course-status', 'Error: ' + res.error, 'error');
            }
        })
        .withFailureHandler(function(e) {
            App.ui.setStatus('edit-course-status', 'Error: ' + e.message, 'error');
        })
        .api_updateCourse(courseDetails);
  }

  function closeEditCourseModal() {
    document.getElementById('edit-course-modal-overlay').style.display = 'none';
    App.ui.setStatus('edit-course-status', '', 'clear');
    var form = document.getElementById('edit-course-form');
    if (form) form.reset();
  }

  function handleExportCourses() {
      if (!cachedCourseAssignments || cachedCourseAssignments.length === 0) return;
      setSchedulingStatus("Exporting...", 'loading');
      google.script.run
        .withSuccessHandler(function(res) {
            if(res.success && res.url) { 
                setSchedulingStatus("Export successful.", 'success');
                window.open(res.url, '_blank'); 
            } else { 
                var message = res && res.message ? res.message : 'Unknown error';
                setSchedulingStatus("Export Failed: " + message, 'error'); 
            }
        })
        .withFailureHandler(function(e) {
            setSchedulingStatus("Export failed: " + e.message, 'error');
        })
        .api_exportCourseAssignments(cachedCourseAssignments);
  }

  // --- INIT ---
  document.addEventListener('DOMContentLoaded', function() {
      var mstTab = document.querySelector('.tab-nav-item[onclick*="tab-mst-assign"]');
      if (mstTab) {
          mstTab.addEventListener('click', loadSchedulingRosterData);
      }
      
      if (document.getElementById('sched-assignments-list')) {
          loadSchedulingRosterData();
      }
  });
</script>
