<script>
/**
 * ===================================================================
 * PROCTORING TOOL LOGIC (NURSING & MLT)
 * ===================================================================
 */

// Store for the data returned from the analysis step
let nursing_parsedData = null;

/**
 * Initializes the Nursing Proctoring page listeners. 
 */
function load_exams() {
    if (window.pageExamsListenersAttached) return;

    document.getElementById('nursing-analyze-btn').addEventListener('click', handleAnalyzeClick);
    document.getElementById('nursing-confirm-create-btn').addEventListener('click', handleConfirmCreateAllClick);
    document.getElementById('nursing-cancel-btn').addEventListener('click', resetNursingView);
    
    const calendarTabButton = document.getElementById('nursing-calendar-tab-btn');
    if (calendarTabButton) {
        calendarTabButton.addEventListener('click', function() {
            if (!this.hasAttribute('data-loaded')) {
                nursing_loadCalendarOptions();
                this.setAttribute('data-loaded', 'true');
            }
        });
    }
    
    resetNursingView();
    window.pageExamsListenersAttached = true;
}

/**
 * Manages the UI state of a specific step in the accordion guide.
 */
function setStepState(stepNumber, state) {
    const step = document.getElementById(`nursing-step-${stepNumber}`);
    if (!step) return;

    step.classList.remove('completed');
    step.open = false;
    step.removeAttribute('disabled');

    switch (state) {
        case 'active':
            step.open = true;
            break;
        case 'completed':
            step.classList.add('completed');
            break;
        case 'disabled':
            step.setAttribute('disabled', 'true');
            break;
    }
}

/**
 * Resets the entire nursing proctoring tool to its initial state.
 */
function resetNursingView() {
    setStepState(1, 'active');
    setStepState(2, 'disabled');
    setStepState(3, 'disabled');

    document.getElementById('nursing-summary-output').innerHTML = '';
    document.getElementById('nursing-preview-output').innerHTML = '';
    document.getElementById('nursing-sheet-url-input').value = '';
    setStatus('nursing-status', '', 'clear');
    nursing_parsedData = null;
}

/**
 * Handles the click of the "Analyze Sheet" button.
 */
function handleAnalyzeClick() {
    const sheetUrl = document.getElementById('nursing-sheet-url-input').value;
    setStatus('nursing-status', 'Analyzing all sheets... This may take a moment.', 'loading');

    google.script.run
        .withSuccessHandler(response => {
            if (response.success) {
                nursing_parsedData = response.data;
                displayNursingPreview(response.data);
                
                setStepState(1, 'completed');
                setStepState(2, 'active');
                setStepState(3, 'active');

                setStatus('nursing-status', 'Analysis complete. Review the details below.', 'success');
            } else {
                setStatus('nursing-status', response.message, 'error');
                nursing_parsedData = null;
            }
        })
        .withFailureHandler(err => setStatus('nursing-status', `An unexpected error occurred: ${err.message}`, 'error'))
        .analyzeNursingSheet(sheetUrl);
}

/**
 * Gathers all data from the UI, including accommodations, and prepares it for the backend.
 */
function getPayloadWithAccommodations() {
    if (!nursing_parsedData) return null;

    const payload = JSON.parse(JSON.stringify(nursing_parsedData));

    payload.sheets.forEach((sheet, sheetIndex) => {
        sheet.exams.forEach((exam, examIndex) => {
            const uniqueId = `exam-${sheetIndex}-${examIndex}`;
            const textarea = document.getElementById(`${uniqueId}-accommodations`);
            if (textarea) {
                exam.accommodations = textarea.value; 
            }
        });
    });
    return payload;
}


/**
 * Handles click for creating all documents from all sheets.
 */
function handleConfirmCreateAllClick() {
    const payload = getPayloadWithAccommodations();
    if (!payload) return;

    const createEvents = document.getElementById('nursing-create-calendar-events-checkbox').checked;
    const totalExams = payload.sheets.reduce((acc, sheet) => acc + sheet.exams.length, 0);

    if (!confirm(`This will create or update ${totalExams} document(s) for ALL sheets. Proceed?`)) return;

    setStatus('nursing-status', 'Creating all documents... Please wait.', 'loading');
    google.script.run
        .withSuccessHandler(response => {
            setStatus('nursing-status', response.message, response.success ? 'success' : 'error');
            if (response.success) {
                setStepState(2, 'completed');
                setStepState(3, 'completed');
            }
        })
        .withFailureHandler(err => setStatus('nursing-status', `An unexpected error: ${err.message}`, 'error'))
        .createNursingProctoringDocuments(payload, createEvents);
}


/**
 * Gets a data payload for a single exam, including its specific accommodation notes.
 */
function getSingleExamPayload(sheetIndex, examIndex) {
    if (!nursing_parsedData || !nursing_parsedData.sheets[sheetIndex]) return null;
    
    const payload = getPayloadWithAccommodations();
    const sheet = payload.sheets[sheetIndex];
    const exam = sheet.exams[examIndex];

    return {
        ...payload,
        sheets: [{
            ...sheet,
            exams: [exam]
        }]
    };
}


/**
 * Handles click for creating a document for a single exam.
 */
function handleCreateSingleExamClick(sheetIndex, examIndex) {
    const singleExamPayload = getSingleExamPayload(sheetIndex, examIndex);
    if (!singleExamPayload) return;

    const createEvents = document.getElementById('nursing-create-calendar-events-checkbox').checked;
    const exam = singleExamPayload.sheets[0].exams[0];

    setStatus('nursing-status', `Creating document for "${exam.name}"...`, 'loading');
    google.script.run
        .withSuccessHandler(response => handleSingleDocResponse(response, sheetIndex, examIndex))
        .withFailureHandler(err => setStatus('nursing-status', `An unexpected error: ${err.message}`, 'error'))
        .createNursingProctoringDocuments(singleExamPayload, createEvents);
}

/**
 * Handles click for updating a document for a single exam.
 */
function handleUpdateSingleExamClick(sheetIndex, examIndex) {
    const singleExamPayload = getSingleExamPayload(sheetIndex, examIndex);
    if (!singleExamPayload) return;

    const createEvents = false; 
    const exam = singleExamPayload.sheets[0].exams[0];

    setStatus('nursing-status', `Updating document for "${exam.name}"...`, 'loading');
    google.script.run
        .withSuccessHandler(response => handleSingleDocResponse(response, sheetIndex, examIndex))
        .withFailureHandler(err => setStatus('nursing-status', `An unexpected error: ${err.message}`, 'error'))
        .updateAllNursingDocuments(singleExamPayload, createEvents);
}


/**
 * Handles the backend response for a single document creation/update.
 */
function handleSingleDocResponse(response, sheetIndex, examIndex) {
    setStatus('nursing-status', response.message, response.success ? 'success' : 'error');

    if (response.success && response.docUrl) {
        nursing_parsedData.sheets[sheetIndex].exams[examIndex].docUrl = response.docUrl;

        const examDetailContainer = document.getElementById(`exam-${sheetIndex}-${examIndex}-details`);
        if (examDetailContainer) {
             const linkContainer = examDetailContainer.querySelector('.exam-doc-link-container');
             linkContainer.innerHTML = `<a href="${response.docUrl}" target="_blank" class="button btn-sm">View Document</a>`;

             const createBtn = examDetailContainer.querySelector('.create-btn');
             if(createBtn) createBtn.hidden = true;

             const updateBtn = examDetailContainer.querySelector('.update-btn');
             if(updateBtn) updateBtn.disabled = false;
        }
    }
}


/**
 * Renders the entire preview area, including summary cards and the new nested accordions.
 */
function displayNursingPreview(data) {
    if (!data.sheets || data.sheets.length === 0) {
        document.getElementById('nursing-preview-output').innerHTML = '<p>No valid exam data found.</p>';
        return;
    }

    document.getElementById('nursing-summary-output').innerHTML = renderNursingSummary(data);
    document.getElementById('nursing-preview-output').innerHTML = renderNursingDetails(data);
}

/**
 * Generates the HTML for the summary cards grid.
 */
function renderNursingSummary(data) {
    const totalExams = data.sheets.reduce((acc, sheet) => acc + sheet.exams.length, 0);
    const totalCourses = data.sheets.length;

    let html = '';
    html += `<div class="summary-card courses"><div class="summary-card-icon">&#128218;</div><div class="summary-card-value">${totalCourses}</div><div class="summary-card-title">Courses Found</div></div>`;
    html += `<div class="summary-card exams"><div class="summary-card-icon">&#128221;</div><div class="summary-card-value">${totalExams}</div><div class="summary-card-title">Total Exams</div></div>`;
    return html;
}

/**
 * Generates the HTML for the nested accordion view of courses and exams.
 */
function renderNursingDetails(data) {
    let html = '';
    data.sheets.forEach((sheet, sheetIndex) => {
        html += `<details class="course-accordion" open>
                    <summary>${sheet.course.code || 'Course'} - ${sheet.course.name || sheet.sheetName}</summary>
                    <div class="guide-content">`;

        if (sheet.exams.length > 0) {
            sheet.exams.forEach((exam, examIndex) => {
                const uniqueId = `exam-${sheetIndex}-${examIndex}`;
                html += `<details class="exam-accordion" open>
                            <summary>${exam.name || 'Untitled Exam'}</summary>
                            ${renderExamDetails(exam, sheet.course, uniqueId, sheetIndex, examIndex)}
                         </details>`;
            });
        } else {
            html += '<p>No exams found in this course tab.</p>';
        }
        html += `</div></details>`;
    });
    return html;
}

/**
 * Generates the key-value HTML for a single exam's details, now including an accommodations textarea.
 */
function renderExamDetails(exam, course, uniqueId, sheetIndex, examIndex) {
    const hasDoc = !!exam.docUrl;

    let detailsHtml = `<div class="exam-details-container" id="${uniqueId}-details">
                        <div class="exam-details">
                            <div class="exam-details-label">Exam Name</div><div class="exam-details-value">${exam.name || 'N/A'}</div>
                            <div class="exam-details-label">Date</div><div class="exam-details-value">${exam.date || 'N/A'}</div>
                            <div class="exam-details-label">On-Site Time</div><div class="exam-details-value">${exam.siteTime || 'N/A'}</div>
                            <div class="exam-details-label">Zoom Time</div><div class="exam-details-value">${exam.zoomTime || 'N/A'}</div>
                            <div class="exam-details-label">Password</div><div class="exam-details-value">${exam.password || 'N/A'}</div>
                            <div class="exam-details-label">Instructor</div><div class="exam-details-value">${course.faculty || 'N/A'}</div>
                         </div>

                         <div class="form-group" style="margin-top: 15px;">
                            <label for="${uniqueId}-accommodations">Accommodations & Special Notes</label>
                            <textarea id="${uniqueId}-accommodations" class="accommodations-textarea" rows="3" placeholder="Enter any specific accommodations for this exam...">${exam.accommodations || ''}</textarea>
                        </div>

                         <div class="divider"></div>
                         <div class="button-group">
                            <div class="exam-doc-link-container">${hasDoc ? `<a href="${exam.docUrl}" target="_blank" class="button btn-sm">View Document</a>` : ''}</div>
                            <button class="button btn-sm secondary create-btn" onclick="handleCreateSingleExamClick(${sheetIndex}, ${examIndex})" ${hasDoc ? 'hidden' : ''}>Create Doc</button>
                            <button class="button btn-sm update-btn" onclick="handleUpdateSingleExamClick(${sheetIndex}, ${examIndex})" ${!hasDoc ? 'disabled' : ''}>Update Doc</button>
                         </div>
                       </div>`;
    return detailsHtml;
}


/** Calendar-specific functions */
function nursing_loadCalendarOptions() {
  google.script.run.withSuccessHandler(res => {
      const select = document.getElementById('nursing-calendar-select');
      if(!select) return;
      select.innerHTML = '<option value="" disabled selected>Select a Calendar...</option>';
      if (res.success && res.data) { 
          res.data.forEach(cal => { 
              const opt = document.createElement('option'); 
              opt.value = cal.id; 
              opt.text = cal.name; 
              select.appendChild(opt); 
          }); 
      }
      select.disabled = false;
      document.getElementById('nursing-calendar-id-input').disabled = false;
      document.getElementById('nursing-calendar-sync-btn').disabled = false;
  }).getWritableCalendars();
}

function nursing_handleCalendarSync() {
    setStatus('nursing-calendar-status', 'This feature is temporarily disabled.', 'error');
}

/** Generic Sub-tab navigation */
function navigateToSubTab(clickedTabElement, targetPaneId) {
    const pageContainer = clickedTabElement.closest('.page');
    if (!pageContainer) return;
    pageContainer.querySelectorAll('.tab-nav-item').forEach(tab => tab.classList.remove('active'));
    pageContainer.querySelectorAll('.tab-page').forEach(pane => pane.classList.remove('active'));
    clickedTabElement.classList.add('active');
    const targetPane = pageContainer.querySelector('#' + targetPaneId);
    if (targetPane) targetPane.classList.add('active');
}

</script>
